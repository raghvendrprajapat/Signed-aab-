name: Build Web to Signed Android

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      WEB_URL:
        description: "URL to web code (prefer a zip of built web files). If not zip, workflow will attempt to mirror the site."
        required: true
        default: "https://example.com/my-built-web.zip"
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer. Must increase every Play upload"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target / compile SDK"
        required: true
        default: "35"
      MIN_SDK:
        description: "Min SDK"
        required: true
        default: "22"
      ALLOW_MIXED_CONTENT:
        description: "Allow http:// content? true/false"
        required: true
        default: "false"
      PLUGINS:
        description: "Extra native plugins to include"
        required: true
        type: choice
        default: "none"
        options:
          - "none"
          - "camera"
          - "push"
          - "location"
          - "all"
      ASSETS_URL:
        description: "Optional: URL to zip/folder containing icon_xxxhdpi.png, splash.png etc (single URL). Leave empty to skip."
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 75

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      WEB_URL: ${{ github.event.inputs.WEB_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      MIN_SDK: ${{ github.event.inputs.MIN_SDK }}
      ALLOW_MIXED_CONTENT: ${{ github.event.inputs.ALLOW_MIXED_CONTENT }}
      PLUGINS: ${{ github.event.inputs.PLUGINS }}
      ASSETS_URL: ${{ github.event.inputs.ASSETS_URL }}

      KEYSTORE_BASE64:   ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare webDir from WEB_URL
        shell: bash
        run: |
          set -euo pipefail
          echo "WEB_URL=$WEB_URL"
          mkdir -p downloaded_www minimal_www
          if [[ "$ALLOW_MIXED_CONTENT" != "true" && ! "$WEB_URL" =~ ^https:// ]]; then
            echo "❌ WEB_URL must start with https:// (or set ALLOW_MIXED_CONTENT=true)"; exit 1
          fi
          if [[ "$WEB_URL" =~ \.zip$ ]]; then
            echo "Downloading zip from $WEB_URL"
            curl -fsSL "$WEB_URL" -o /tmp/web_download.zip
            unzip -q /tmp/web_download.zip -d downloaded_www || true
          else
            CT=$(curl -fsSLI -o /dev/null -w '%{content_type}' "$WEB_URL" || true)
            if [[ "$CT" =~ zip ]]; then
              curl -fsSL "$WEB_URL" -o /tmp/web_download.zip
              unzip -q /tmp/web_download.zip -d downloaded_www || true
            else
              echo "No zip detected — attempting static mirror (may not work for dynamic SPAs)."
              sudo apt-get update -y
              sudo apt-get install -y wget || true
              wget --mirror --no-parent --adjust-extension --convert-links --page-requisites --directory-prefix=downloaded_www "$WEB_URL" || true
            fi
          fi
          FIRST_INDEX=$(find downloaded_www -type f -iname 'index.html' | head -n1 || true)
          if [ -n "$FIRST_INDEX" ]; then
            BUILD_DIR=$(dirname "$FIRST_INDEX")
            echo "WEB_BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          else
            CHILD=$(find downloaded_www -mindepth 1 -maxdepth 1 -type d | head -n1 || true)
            if [ -n "$CHILD" ]; then
              echo "WEB_BUILD_DIR=$CHILD" >> $GITHUB_ENV
            else
              printf '<!doctype html><html><body style="font-family:sans-serif;text-align:center;padding-top:2rem;">No web files found. Provide a zip of built web assets.</body></html>\n' > minimal_www/index.html
              echo "WEB_BUILD_DIR=minimal_www" >> $GITHUB_ENV
            fi
          fi
          echo "=== WEB_BUILD_DIR contents ==="
          ls -la "${WEB_BUILD_DIR}" || true
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! "$APP_ID" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "❌ APP_ID invalid: $APP_ID"; exit 1
          fi
          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            echo "❌ VERSION_CODE must be integer"; exit 1
          fi
          for var in KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD; do
            if [ -z "${!var:-}" ]; then echo "❌ Missing secret: $var"; exit 1; fi
          done

      - name: Restore keystore
        shell: bash
        run: |
          set -euo pipefail
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
          ls -l android.keystore

      - name: Configure Capacitor (bundled mode)
        shell: bash
        run: |
          set -euo pipefail
          echo "Using WEB_BUILD_DIR=${WEB_BUILD_DIR}"
          npx cap init "$APP_NAME" "$APP_ID" --web-dir="${WEB_BUILD_DIR}" || true
          # write capacitor.config.json safely using printf (avoid heredoc parser issues)
          printf '{\n' > capacitor.config.json
          printf '  "appId": "%s",\n' "$APP_ID" >> capacitor.config.json
          printf '  "appName": "%s",\n' "$APP_NAME" >> capacitor.config.json
          printf '  "webDir": "%s",\n' "$WEB_BUILD_DIR" >> capacitor.config.json
          printf '  "bundledWebRuntime": false,\n' >> capacitor.config.json
          printf '  "android": {\n' >> capacitor.config.json
          if [ "$ALLOW_MIXED_CONTENT" = "true" ]; then
            printf '    "allowMixedContent": true\n' >> capacitor.config.json
          else
            printf '    "allowMixedContent": false\n' >> capacitor.config.json
          fi
          printf '  }\n' >> capacitor.config.json
          printf '}\n' >> capacitor.config.json
          if [ "$PLUGINS" = "camera" ]; then npm install @capacitor/camera; fi
          if [ "$PLUGINS" = "push" ]; then npm install @capacitor/push-notifications; fi
          if [ "$PLUGINS" = "location" ]; then npm install @capacitor/geolocation; fi
          if [ "$PLUGINS" = "all" ]; then npm install @capacitor/camera @capacitor/push-notifications @capacitor/geolocation; fi
          npx cap add android || true
          npx cap sync android

      - name: Apply branding assets from ASSETS_URL
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          if [ -z "${ASSETS_URL:-}" ]; then
            echo "No ASSETS_URL provided — skipping branding."; exit 0
          fi
          mkdir -p /tmp/assets
          if [[ "${ASSETS_URL}" =~ \.zip$ ]]; then
            curl -fsSL "$ASSETS_URL" -o /tmp/assets.zip
            unzip -q /tmp/assets.zip -d /tmp/assets || true
          else
            curl -sfSL "${ASSETS_URL}/icon_xxxhdpi.png" -o /tmp/assets/icon_xxxhdpi.png || true
            curl -sfSL "${ASSETS_URL}/icon.png" -o /tmp/assets/icon.png || true
            curl -sfSL "${ASSETS_URL}/splash.png" -o /tmp/assets/splash.png || true
          fi
          sudo apt-get update -y
          sudo apt-get install -y imagemagick || true
          rm -rf app/src/main/res/mipmap-* app/src/main/res/drawable* app/src/main/res/mipmap-anydpi-v26 || true
          mkdir -p app/src/main/res/mipmap-xxxhdpi app/src/main/res/mipmap-xxhdpi app/src/main/res/mipmap-xhdpi app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-anydpi-v26 app/src/main/res/drawable app/src/main/res/drawable-nodpi
          ICON_SRC=""
          if [ -f /tmp/assets/icon_xxxhdpi.png ]; then ICON_SRC=/tmp/assets/icon_xxxhdpi.png; fi
          if [ -z "$ICON_SRC" ] && [ -f /tmp/assets/icon.png ]; then ICON_SRC=/tmp/assets/icon.png; fi
          if [ -z "$ICON_SRC" ] && [ -f /tmp/assets/raw ]; then ICON_SRC=/tmp/assets/raw; fi
          if [ -n "$ICON_SRC" ]; then
            convert "$ICON_SRC" -background white -alpha remove -alpha off /tmp/icon_flat.png || cp "$ICON_SRC" /tmp/icon_flat.png || true
            convert /tmp/icon_flat.png -resize 192x192\> /tmp/icon_xxxhdpi.png || true
            convert /tmp/icon_flat.png -resize 144x144\> /tmp/icon_xxhdpi.png  || true
            convert /tmp/icon_flat.png -resize 96x96\>   /tmp/icon_xhdpi.png   || true
            convert /tmp/icon_flat.png -resize 72x72\>   /tmp/icon_hdpi.png    || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xxhdpi.png  app/src/main/res/mipmap-xxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xhdpi.png   app/src/main/res/mipmap-xhdpi/ic_launcher_full.png || true
            cp /tmp/icon_hdpi.png    app/src/main/res/mipmap-hdpi/ic_launcher_full.png || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png || true
            cp /tmp/icon_xxhdpi.png  app/src/main/res/mipmap-xxhdpi/ic_launcher.png || true
            cp /tmp/icon_xhdpi.png   app/src/main/res/mipmap-xhdpi/ic_launcher.png || true
            cp /tmp/icon_hdpi.png    app/src/main/res/mipmap-hdpi/ic_launcher.png || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_foreground.png || true
            convert /tmp/icon_flat.png -resize 32x32\> /tmp/icon_bg.png || cp /tmp/icon_flat.png /tmp/icon_bg.png || true
            convert /tmp/icon_bg.png -background white -gravity center -extent 48x48 /tmp/icon_bg.png || true
            cp /tmp/icon_bg.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_background.png || true
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' '  <background android:drawable="@mipmap/ic_launcher_background"/>' '  <foreground android:drawable="@mipmap/ic_launcher_full"/>' '</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml || true
            cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml || true
          fi
          if [ -f /tmp/assets/splash.png ]; then
            convert /tmp/assets/splash.png -background white -alpha remove -alpha off /tmp/splash_flat.png || cp /tmp/assets/splash.png /tmp/splash_flat.png || true
            cp /tmp/splash_flat.png app/src/main/res/drawable-nodpi/splash.png || true
            cp /tmp/splash_flat.png app/src/main/res/drawable/splash.png || true
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<layer-list xmlns:android="http://schemas.android.com/apk/res/android">' '    <item android:drawable="@android:color/white" />' '    <item>' '        <bitmap android:gravity="center" android:src="@drawable/splash" />' '    </item>' '</layer-list>' > app/src/main/res/drawable/launch_background.xml || true
          fi

      - name: Ensure manifest icon entries (use full icon)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          MF="app/src/main/AndroidManifest.xml"
          if [ -f "$MF" ]; then
            perl -0777 -pe '
              if (/<application\b[^>]*>/s) {
                $app = $&; $new = $app;
                if ($new !~ /android:icon=/) { $new =~ s/<application/<application android:icon=\"\@mipmap\/ic_launcher_full\"/; }
                else { $new =~ s/android:icon=\"[^\"]*\"/android:icon=\"\@mipmap\/ic_launcher_full\"/g; }
                if ($new !~ /android:roundIcon=/) { $new =~ s/<application/<application android:roundIcon=\"\@mipmap\/ic_launcher_full\"/; }
                else { $new =~ s/android:roundIcon=\"[^\"]*\"/android:roundIcon=\"\@mipmap\/ic_launcher_full\"/g; }
                s/\Q$app\E/$new/;
              }
            ' -i "$MF" || true
            sed -n '1,80p' "$MF" || true
          fi

      - name: Patch Gradle
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          cp ../android.keystore app/release.keystore
          if [ -f app/build.gradle ]; then FILE="app/build.gradle"; else FILE="app/build.gradle.kts"; fi
          sed -i -E "s/versionCode[ =]+[0-9]+/versionCode ${VERSION_CODE}/" "$FILE" || true
          sed -i -E "s/versionName[ =]+\"[^\"]+\"/versionName \"${VERSION_NAME}\"/" "$FILE" || true
          sed -i -E "s/minSdkVersion[ =]+[0-9]+/minSdkVersion ${MIN_SDK}/" "$FILE" || true
          sed -i -E "s/minSdk[ =]+[0-9]+/minSdk ${MIN_SDK}/" "$FILE" || true
          sed -i -E "s/targetSdkVersion[ =]+[0-9]+/targetSdkVersion ${TARGET_SDK}/" "$FILE" || true
          sed -i -E "s/targetSdk[ =]+[0-9]+/targetSdk ${TARGET_SDK}/" "$FILE" || true
          sed -i -E "s/compileSdkVersion[ =]+[0-9]+/compileSdkVersion ${TARGET_SDK}/" "$FILE" || true
          sed -i -E "s/compileSdk[ =]+[0-9]+/compileSdk ${TARGET_SDK}/" "$FILE" || true
          if ! grep -q "signingConfigs" "$FILE"; then
            {
              echo ""
              echo "android {"
              echo "    signingConfigs {"
              echo "        release {"
              echo "            storeFile file(\"release.keystore\")"
              echo "            storePassword System.getenv(\"KEYSTORE_PASSWORD\")"
              echo "            keyAlias      System.getenv(\"KEY_ALIAS\")"
              echo "            keyPassword   System.getenv(\"KEY_PASSWORD\")"
              echo "        }"
              echo "    }"
              echo "    buildTypes {"
              echo "        release {"
              echo "            signingConfig signingConfigs.release"
              echo "            minifyEnabled false"
              echo "            shrinkResources false"
              echo "            debuggable false"
              echo "        }"
              echo "    }"
              echo "}"
            } >> "$FILE"
          fi
          if [ "${ALLOW_MIXED_CONTENT}" = "true" ]; then
            MF="app/src/main/AndroidManifest.xml"
            if [ -f "$MF" ]; then
              if ! grep -q usesCleartextTraffic "$MF"; then
                sed -i 's/<application /<application android:usesCleartextTraffic="true" /' "$MF"
              fi
            fi
          fi

      - name: Build release
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          ./gradlew clean --no-daemon
          ./gradlew :app:bundleRelease :app:assembleRelease --no-daemon
          mkdir -p ../out_aab ../out_apk
          cp app/build/outputs/bundle/release/*.aab ../out_aab/ || true
          cp app/build/outputs/apk/release/*.apk ../out_apk/   || true
          echo "=== AAB files ==="; ls -l ../out_aab || true
          echo "=== APK files ==="; ls -l ../out_apk || true

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: out_aab

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk
          path: out_apk
