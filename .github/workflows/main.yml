name: Web to Android Offline

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Offline App"
      APP_ID:
        description: "Package ID"
        required: true
        default: "com.example.app"
      WEB_URL:
        description: "Website URL"
        required: true
        default: "https://example.com"
      VERSION_NAME:
        description: "Version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Version code (integer)"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target SDK"
        required: true
        default: "35"
      DOWNLOAD_DEPTH:
        description: "Crawl depth (1-3)"
        required: true
        default: "2"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      WEB_URL: ${{ github.event.inputs.WEB_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      MIN_SDK: "22"
      DOWNLOAD_DEPTH: ${{ github.event.inputs.DOWNLOAD_DEPTH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download Website
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget
          mkdir -p offline_website
          cd offline_website
          wget --recursive --level="${DOWNLOAD_DEPTH}" --no-parent --convert-links --adjust-extension --page-requisites --no-host-directories --restrict-file-names=windows --reject="*.exe,*.dmg,*.zip,*.pdf" --timeout=30 --tries=2 "${WEB_URL}" || true
          if [ ! -f index.html ]; then
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>App</title></head><body style="font-family:sans-serif;text-align:center;padding:50px"><h1>Offline App</h1><p>Content loaded</p></body></html>' > index.html
          fi
          cd ..
          echo "WEB_BUILD_DIR=offline_website" >> $GITHUB_ENV

      - name: Install Capacitor
        run: |
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Validate Inputs
        run: |
          if [[ ! "$APP_ID" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "Invalid APP_ID"
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "Missing ANDROID_KEYSTORE_BASE64 secret"
            exit 1
          fi

      - name: Restore Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android.keystore
          ls -lh android.keystore

      - name: Configure Capacitor
        run: |
          npx cap init "${APP_NAME}" "${APP_ID}" --web-dir="${WEB_BUILD_DIR}" || true
          cat > capacitor.config.json << 'ENDCONFIG'
          {
            "appId": "REPLACE_APP_ID",
            "appName": "REPLACE_APP_NAME",
            "webDir": "REPLACE_WEB_DIR",
            "bundledWebRuntime": true,
            "android": {
              "allowMixedContent": false
            }
          }
          ENDCONFIG
          sed -i "s|REPLACE_APP_ID|${APP_ID}|g" capacitor.config.json
          sed -i "s|REPLACE_APP_NAME|${APP_NAME}|g" capacitor.config.json
          sed -i "s|REPLACE_WEB_DIR|${WEB_BUILD_DIR}|g" capacitor.config.json
          cat capacitor.config.json
          npx cap add android || true
          npx cap sync android

      - name: Configure Gradle
        working-directory: android
        run: |
          cp ../android.keystore app/release.keystore
          FILE="app/build.gradle"
          sed -i "s/versionCode [0-9]*/versionCode ${VERSION_CODE}/" "$FILE"
          sed -i "s/versionName \"[^\"]*\"/versionName \"${VERSION_NAME}\"/" "$FILE"
          sed -i "s/minSdk [0-9]*/minSdk ${MIN_SDK}/" "$FILE"
          sed -i "s/targetSdk [0-9]*/targetSdk ${TARGET_SDK}/" "$FILE"
          sed -i "s/compileSdk [0-9]*/compileSdk ${TARGET_SDK}/" "$FILE"
          if ! grep -q "signingConfigs" "$FILE"; then
            cat >> "$FILE" << 'ENDGRADLE'
          
          android {
              signingConfigs {
                  release {
                      storeFile file("release.keystore")
                      storePassword System.getenv("KEYSTORE_PASSWORD")
                      keyAlias System.getenv("KEY_ALIAS")
                      keyPassword System.getenv("KEY_PASSWORD")
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          ENDGRADLE
          fi

      - name: Build APK and AAB
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew clean --no-daemon
          ./gradlew assembleRelease bundleRelease --no-daemon
          mkdir -p ../output/apk ../output/aab
          cp app/build/outputs/apk/release/*.apk ../output/apk/ || true
          cp app/build/outputs/bundle/release/*.aab ../output/aab/ || true

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: output/apk

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: output/aab
