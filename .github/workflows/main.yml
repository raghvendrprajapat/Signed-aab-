name: Build Web to Signed Android

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer version code"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target SDK version"
        required: true
        default: "35"
      ALLOW_MIXED_CONTENT:
        description: "Allow HTTP content? true/false"
        required: true
        default: "false"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      ALLOW_MIXED_CONTENT: ${{ github.event.inputs.ALLOW_MIXED_CONTENT }}
      MIN_SDK: "22"

      KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install and Build Web
        shell: bash
        run: |
          set -e
          if [ -f package.json ]; then
            npm ci || npm install
            npm run build || true
            for dir in dist build public; do
              if [ -d "$dir" ]; then
                echo "WEB_BUILD_DIR=$dir" >> $GITHUB_ENV
                break
              fi
            done
          fi
          if ! grep -q WEB_BUILD_DIR $GITHUB_ENV; then
            mkdir minimal_www && echo "<h1>Offline App</h1>" > minimal_www/index.html
            echo "WEB_BUILD_DIR=minimal_www" >> $GITHUB_ENV
          fi
          npm install -D @capacitor/cli @capacitor/core @capacitor/android

      - name: Decode Keystore
        shell: bash
        run: |
          set -e
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore

      - name: Initialize Capacitor Project
        shell: bash
        run: |
          set -e
          npx cap init "$APP_NAME" "$APP_ID" --web-dir="$WEB_BUILD_DIR" || true
          cat > capacitor.config.json <<EOF
{
  "appId": "${APP_ID}",
  "appName": "${APP_NAME}",
  "webDir": "${WEB_BUILD_DIR}",
  "bundledWebRuntime": true,
  "server": {
    "cleartext": ${ALLOW_MIXED_CONTENT}
  }
}
EOF
          npx cap add android || true
          npx cap copy android || true
          npx cap sync android || true

      - name: Copy Web Build into Android Assets
        shell: bash
        run: |
          set -e
          mkdir -p android/app/src/main/assets/public
          mkdir -p android/app/src/main/assets/www
          cp -a "$WEB_BUILD_DIR/." android/app/src/main/assets/public/
          cp -a "$WEB_BUILD_DIR/." android/app/src/main/assets/www/
          echo "Web assets copied."

      - name: Configure Signing in Gradle
        shell: bash
        working-directory: android
        run: |
          set -e
          cp ../android.keystore app/release.keystore
          FILE="app/build.gradle"
          if [ ! -f "$FILE" ]; then FILE="app/build.gradle.kts"; fi
          sed -i -E "s/versionCode [0-9]+/versionCode ${VERSION_CODE}/" "$FILE" || true
          sed -i -E "s/versionName \".*\"/versionName \"${VERSION_NAME}\"/" "$FILE" || true
          if ! grep -q "signingConfigs" "$FILE"; then
            cat >> "$FILE" <<'GRADLE'
android {
    signingConfigs {
        release {
            storeFile file("release.keystore")
            storePassword System.getenv("KEYSTORE_PASSWORD")
            keyAlias System.getenv("KEY_ALIAS")
            keyPassword System.getenv("KEY_PASSWORD")
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
            minifyEnabled false
            shrinkResources false
            debuggable false
        }
    }
}
GRADLE
          fi

      - name: Build Release APK & AAB
        shell: bash
        working-directory: android
        run: |
          set -e
          ./gradlew clean
          ./gradlew :app:bundleRelease :app:assembleRelease
          mkdir -p ../outputs/aab ../outputs/apk
          cp app/build/outputs/bundle/release/*.aab ../outputs/aab/ || true
          cp app/build/outputs/apk/release/*.apk ../outputs/apk/ || true

      - name: Upload Signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: outputs/aab

      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk
          path: outputs/apk
