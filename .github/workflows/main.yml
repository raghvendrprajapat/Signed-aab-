name: Build Web to Signed Android

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      WEB_URL:
        description: "Live URL (must be https:// unless you allow http) - not used for bundled builds"
        required: true
        default: "https://example.com"
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer. Must increase every Play upload"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target / compile SDK"
        required: true
        default: "35"
      ALLOW_MIXED_CONTENT:
        description: "Allow http:// content? true/false (not recommended)"
        required: true
        default: "false"
      PLUGINS:
        description: "Extra native plugins to include"
        required: true
        type: choice
        default: "none"
        options:
          - "none"
          - "camera"
          - "push"
          - "location"
          - "all"
      APP_ICON_URL:
        description: "Full URL to icon file OR public folder URL containing icon_xxxhdpi.png etc (optional)"
        required: false
        default: ""
      SPLASH_SCREEN_URL:
        description: "Full URL to splash file OR public folder URL containing splash.png (optional)"
        required: false
        default: ""
      PRIVACY_POLICY_URL:
        description: "Privacy policy URL (required if you show ads)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      WEB_URL: ${{ github.event.inputs.WEB_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      MIN_SDK: "22"
      ALLOW_MIXED_CONTENT: ${{ github.event.inputs.ALLOW_MIXED_CONTENT }}
      PLUGINS: ${{ github.event.inputs.PLUGINS }}
      PRIVACY_POLICY_URL: ${{ github.event.inputs.PRIVACY_POLICY_URL }}

      KEYSTORE_BASE64:   ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java (use 17 for Android builds)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Android SDK (ensure required build tools)
        uses: android-actions/setup-android@v3
        with:
          api-levels: 35
          build-tools: "33.0.2"
          components: "platform-tools,cmdline-tools;latest"

      - name: Prepare webDir
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
            if npm run | grep -q " build"; then npm run build || true; fi
            for d in dist build public; do
              if [ -d "$d" ]; then echo "WEB_BUILD_DIR=$d" >> $GITHUB_ENV; break; fi
            done
          fi
          if ! grep -q WEB_BUILD_DIR $GITHUB_ENV 2>/dev/null; then
            mkdir -p minimal_www
            printf '<!doctype html><html><body style="font-family:sans-serif;text-align:center;padding-top:2rem;">Loading…</body></html>\n' > minimal_www/index.html
            echo "WEB_BUILD_DIR=minimal_www" >> $GITHUB_ENV
          fi
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! "$APP_ID" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "❌ APP_ID invalid: $APP_ID"; exit 1
          fi
          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then echo "❌ VERSION_CODE must be integer"; exit 1; fi
          if [[ "$ALLOW_MIXED_CONTENT" != "true" && ! "$WEB_URL" =~ ^https:// ]]; then
            echo "❌ WEB_URL must start with https:// (or set ALLOW_MIXED_CONTENT=true)"; exit 1
          fi
          # keystore secrets required
          for var in KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD; do
            if [ -z "${!var:-}" ]; then echo "❌ Missing secret: $var"; exit 1; fi
          done
          # Privacy policy required if you plan to show ads or collect personal data
          if [ -z "${PRIVACY_POLICY_URL:-}" ]; then
            echo "⚠️ PRIVACY_POLICY_URL not provided. If you show ads or collect personal data, Play will require a valid privacy policy URL."
          fi

      - name: Restore keystore (safe)
        shell: bash
        run: |
          set -euo pipefail
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
          chmod 600 android.keystore
          # COPY to android app folder later (no printing)

      - name: Configure Capacitor (bundle web assets, no remote server)
        shell: bash
        run: |
          set -euo pipefail
          echo "WEB_BUILD_DIR currently set to: $WEB_BUILD_DIR"

          if [ ! -d "$WEB_BUILD_DIR" ] || [ -z "$(ls -A "$WEB_BUILD_DIR" 2>/dev/null || true)" ]; then
            echo "❌ WEB_BUILD_DIR ($WEB_BUILD_DIR) is missing or empty. Build your web app first."
            ls -la || true
            exit 1
          fi

          npx cap init "$APP_NAME" "$APP_ID" --web-dir="$WEB_BUILD_DIR" || true

          if [ "$ALLOW_MIXED_CONTENT" = "true" ]; then amc=true; else amc=false; fi
          cat > capacitor.config.json <<EOF
{
  "appId": "${APP_ID}",
  "appName": "${APP_NAME}",
  "webDir": "${WEB_BUILD_DIR}",
  "bundledWebRuntime": false,
  "android": {
    "allowMixedContent": ${amc}
  }
}
EOF

          if [ "$PLUGINS" = "camera" ]; then npm install @capacitor/camera
          elif [ "$PLUGINS" = "push" ]; then npm install @capacitor/push-notifications
          elif [ "$PLUGINS" = "location" ]; then npm install @capacitor/geolocation
          elif [ "$PLUGINS" = "all" ]; then npm install @capacitor/camera @capacitor/push-notifications @capacitor/geolocation
          fi

          npx cap add android || true
          npx cap copy android
          npx cap sync android

          if [ -f android/app/src/main/assets/public/index.html ]; then
            echo "✅ Bundled web assets found in android/app/src/main/assets/public"
            ls -la android/app/src/main/assets/public | sed -n '1,100p' || true
          else
            echo "❌ Bundled web assets NOT found at android/app/src/main/assets/public — build will show remote or blank screen"
            ls -la android/app/src/main/assets || true
            exit 1
          fi

      - name: Apply branding assets from URL(s) (robust)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail

          ICON_SRC="${{ github.event.inputs.APP_ICON_URL }}"
          SPLASH_SRC="${{ github.event.inputs.SPLASH_SCREEN_URL }}"

          if [ -z "$ICON_SRC" ] && [ -z "$SPLASH_SRC" ]; then
            echo "No branding URLs provided — skipping branding download"; exit 0
          fi

          dl() {
            url="$1"; out="$2"
            echo "curl -> $url  -> $out"
            curl -sfSL "$url" -o "$out" || { echo "curl failed for $url (ignored)"; }
          }

          if [ -n "$ICON_SRC" ]; then
            if [[ "$ICON_SRC" =~ \.png$ ]]; then
              dl "$ICON_SRC" /tmp/icon_src.png
            else
              case "$ICON_SRC" in */) ;; *) ICON_SRC="$ICON_SRC/";; esac
              dl "${ICON_SRC}icon_xxxhdpi.png" /tmp/icon_src.png || true
              if [ ! -f /tmp/icon_src.png ]; then dl "${ICON_SRC}icon.png" /tmp/icon_src.png || true; fi
            fi
          fi

          if [ -n "$SPLASH_SRC" ]; then
            if [[ "$SPLASH_SRC" =~ \.png$ ]]; then
              dl "$SPLASH_SRC" /tmp/splash.png
            else
              case "$SPLASH_SRC" in */) ;; *) SPLASH_SRC="$SPLASH_SRC/";; esac
              dl "${SPLASH_SRC}splash.png" /tmp/splash.png || true
            fi
          fi

          echo "Purging old generated resource folders..."
          rm -rf app/src/main/res/mipmap-* app/src/main/res/drawable* app/src/main/res/mipmap-anydpi-v26 || true

          mkdir -p app/src/main/res/mipmap-xxxhdpi app/src/main/res/mipmap-xxhdpi app/src/main/res/mipmap-xhdpi app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-anydpi-v26
          mkdir -p app/src/main/res/drawable app/src/main/res/drawable-nodpi

          if [ -f /tmp/icon_src.png ]; then
            echo "Processing source icon..."
            sudo apt-get update -y
            sudo apt-get install -y imagemagick || true
            convert /tmp/icon_src.png -background white -alpha remove -alpha off /tmp/icon_flat.png || cp /tmp/icon_src.png /tmp/icon_flat.png || true
            convert /tmp/icon_flat.png -resize 192x192\> /tmp/icon_xxxhdpi.png || true
            convert /tmp/icon_flat.png -resize 144x144\> /tmp/icon_xxhdpi.png  || true
            convert /tmp/icon_flat.png -resize 96x96\>   /tmp/icon_xhdpi.png   || true
            convert /tmp/icon_flat.png -resize 72x72\>   /tmp/icon_hdpi.png    || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xxhdpi.png  app/src/main/res/mipmap-xxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xhdpi.png   app/src/main/res/mipmap-xhdpi/ic_launcher_full.png || true
            cp /tmp/icon_hdpi.png    app/src/main/res/mipmap-hdpi/ic_launcher_full.png || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png || true
            cp /tmp/icon_xxhdpi.png  app/src/main/res/mipmap-xxhdpi/ic_launcher.png || true
            cp /tmp/icon_xhdpi.png   app/src/main/res/mipmap-xhdpi/ic_launcher.png || true
            cp /tmp/icon_hdpi.png    app/src/main/res/mipmap-hdpi/ic_launcher.png || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_foreground.png || true
            convert /tmp/icon_flat.png -resize 32x32\> /tmp/icon_bg.png || cp /tmp/icon_flat.png /tmp/icon_bg.png || true
            convert /tmp/icon_bg.png -background white -gravity center -extent 48x48 /tmp/icon_bg.png || true
            cp /tmp/icon_bg.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_background.png || true
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' \
              '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' \
              '  <background android:drawable="@mipmap/ic_launcher_background"/>' \
              '  <foreground android:drawable="@mipmap/ic_launcher_full"/>' \
              '</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml || true
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' \
              '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' \
              '  <background android:drawable="@mipmap/ic_launcher_background"/>' \
              '  <foreground android:drawable="@mipmap/ic_launcher_full"/>' \
              '</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml || true
            echo "Icon densities and full variants created."
          else
            echo "No icon source found — skipping icon generation."
          fi

          if [ -f /tmp/splash.png ]; then
            echo "Installing splash image..."
            sudo apt-get update -y
            sudo apt-get install -y imagemagick || true
            convert /tmp/splash.png -background white -alpha remove -alpha off /tmp/splash_flat.png || cp /tmp/splash.png /tmp/splash_flat.png || true
            cp /tmp/splash_flat.png app/src/main/res/drawable-nodpi/splash.png || true
            cp /tmp/splash_flat.png app/src/main/res/drawable/splash.png || true
            LAUNCH_XML="app/src/main/res/drawable/launch_background.xml"
            mkdir -p app/src/main/res/drawable
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' \
              '<layer-list xmlns:android="http://schemas.android.com/apk/res/android">' \
              '    <item android:drawable="@android:color/white" />' \
              '    <item>' \
              '        <bitmap android:gravity="center" android:src="@drawable/splash" />' \
              '    </item>' \
              '</layer-list>' > "$LAUNCH_XML" || true
            echo "Splash applied and launch_background created/updated."
          else
            echo "No /tmp/splash.png found — splash not applied."
          fi

      - name: Ensure manifest icon entries (use full icon)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          MF="app/src/main/AndroidManifest.xml"
          if [ ! -f "$MF" ]; then echo "No AndroidManifest.xml found — skipping manifest patch"; exit 0; fi
          perl -0777 -pe '
            if (/<application\b[^>]*>/s) {
              $app = $&;
              $new = $app;
              if ($new !~ /android:icon=/) { $new =~ s/<application/<application android:icon=\"\@mipmap\/ic_launcher_full\"/; }
              else { $new =~ s/android:icon=\"[^\"]*\"/android:icon=\"\@mipmap\/ic_launcher_full\"/g; }
              if ($new !~ /android:roundIcon=/) { $new =~ s/<application/<application android:roundIcon=\"\@mipmap\/ic_launcher_full\"/; }
              else { $new =~ s/android:roundIcon=\"[^\"]*\"/android:roundIcon=\"\@mipmap\/ic_launcher_full\"/g; }
              s/\Q$app\E/$new/;
            }
          ' -i "$MF" || true
          echo "Patched AndroidManifest (first lines):"
          sed -n '1,80p' "$MF" || true

      - name: Patch Gradle & Manifest (signing, versions, permissions, exported)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail

          # copy keystore into android module
          cp ../android.keystore app/release.keystore || true
          chmod 600 app/release.keystore || true

          # update version codes and SDK targets (works for Groovy and simple Kotlin DSL cases)
          if [ -f app/build.gradle ]; then FILE="app/build.gradle"; else FILE="app/build.gradle.kts"; fi
          sed -i -E "s/versionCode[ =]+[0-9]+/versionCode $VERSION_CODE/" "$FILE" || true
          sed -i -E "s/versionName[ =]+\"[^\"]+\"/versionName \"$VERSION_NAME\"/" "$FILE" || true
          sed -i -E "s/minSdkVersion[ =]+[0-9]+/minSdkVersion $MIN_SDK/" "$FILE" || true
          sed -i -E "s/minSdk[ =]+[0-9]+/minSdk $MIN_SDK/" "$FILE" || true
          sed -i -E "s/targetSdkVersion[ =]+[0-9]+/targetSdkVersion $TARGET_SDK/" "$FILE" || true
          sed -i -E "s/targetSdk[ =]+[0-9]+/targetSdk $TARGET_SDK/" "$FILE" || true
          sed -i -E "s/compileSdkVersion[ =]+[0-9]+/compileSdkVersion $TARGET_SDK/" "$FILE" || true
          sed -i -E "s/compileSdk[ =]+[0-9]+/compileSdk $TARGET_SDK/" "$FILE" || true

          # inject signing config if not present (quick-safe append)
          if ! grep -q "signingConfigs" "$FILE"; then
            {
              echo ""
              echo "android {"
              echo "    signingConfigs {"
              echo "        release {"
              echo "            storeFile file(\"release.keystore\")"
              echo "            storePassword System.getenv(\"KEYSTORE_PASSWORD\")"
              echo "            keyAlias      System.getenv(\"KEY_ALIAS\")"
              echo "            keyPassword   System.getenv(\"KEY_PASSWORD\")"
              echo "        }"
              echo "    }"
              echo "    buildTypes {"
              echo "        release {"
              echo "            signingConfig signingConfigs.release"
              echo "            minifyEnabled false"
              echo "            shrinkResources false"
              echo "            debuggable false"
              echo "        }"
              echo "    }"
              echo "}"
            } >> "$FILE"
          fi

          # modify manifest: add POST_NOTIFICATIONS and conditional perms, and ensure android:exported on activities with intent-filters
          MF="app/src/main/AndroidManifest.xml"
          if [ -f "$MF" ]; then
            # add POST_NOTIFICATIONS if missing (Android 13+)
            if ! grep -q "android.permission.POST_NOTIFICATIONS" "$MF"; then
              sed -i '/<manifest /a <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />' "$MF"
            fi
            # add location perms if requested
            if [ "$PLUGINS" = "location" ] || [ "$PLUGINS" = "all" ]; then
              if ! grep -q "ACCESS_FINE_LOCATION" "$MF"; then
                sed -i '/<manifest /a <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />' "$MF"
                sed -i '/<manifest /a <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />' "$MF"
                sed -i '/<application /i <uses-feature android:name="android.hardware.location.gps" android:required="false" />' "$MF"
              fi
            fi
            # add camera perm if requested
            if [ "$PLUGINS" = "camera" ] || [ "$PLUGINS" = "all" ]; then
              if ! grep -q "android.permission.CAMERA" "$MF"; then
                sed -i '/<manifest /a <uses-permission android:name="android.permission.CAMERA" />' "$MF"
                sed -i '/<application /i <uses-feature android:name="android.hardware.camera" android:required="false" />' "$MF"
              fi
            fi

            # Add android:exported="true" to any <activity ...> tags that contain an <intent-filter>
            # Only add if android:exported is missing
            perl -0777 -i -pe '
              while (/<activity\b([^>]*)>/g) {
                $attrs=$1;
              }
              # the following substitution processes activity opening tags that are followed by an intent-filter,
              # and that do NOT already contain android:exported; it inserts android:exported="true"
              s{<activity\b([^>]*?)>(?=[\s\S]*?<intent-filter)}{
                my $a=$1;
                if ($a !~ /android:exported\s*=/) {
                  "<activity".$a." android:exported=\"true\">";
                } else {
                  "<activity".$a.">";
                }
              }ge;
            ' "$MF" || true

          fi

      - name: Make gradlew executable
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          if [ -f ./gradlew ]; then chmod +x ./gradlew || true; fi

      - name: Build release (robust copy & debug)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          ./gradlew clean --no-daemon
          ./gradlew :app:bundleRelease :app:assembleRelease --no-daemon || true

          mkdir -p ../out_aab ../out_apk

          mapfile -d '' aabs < <(find app/build -type f -name '*.aab' -print0 2>/dev/null || true)
          if [ "${#aabs[@]}" -gt 0 ]; then
            echo "Found ${#aabs[@]} AAB(s); copying to ../out_aab"
            for f in "${aabs[@]}"; do cp "$f" ../out_aab/ || true; done
          else
            echo "ERROR: No .aab files found in app/build outputs. Listing app/build contents for debug:"
            find app/build -maxdepth 6 -type f -printf '%p\n' || true
            exit 1
          fi

          mapfile -d '' apks < <(find app/build -type f -name '*.apk' -print0 2>/dev/null || true)
          if [ "${#apks[@]}" -gt 0 ]; then
            echo "Found ${#apks[@]} APK(s); copying to ../out_apk"
            for f in "${apks[@]}"; do cp "$f" ../out_apk/ || true; done
          else
            echo "No APK files found (this is OK if only AAB produced)."
          fi

          echo "=== FINAL: repo-root/out_aab ==="
          ls -l ../out_aab || true
          echo "=== FINAL: repo-root/out_apk ==="
          ls -l ../out_apk || true

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: out_aab

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk
          path: out_apk
