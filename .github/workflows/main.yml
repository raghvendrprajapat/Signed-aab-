name: Build Web to Signed Android (force-bundle)

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      WEB_URL:
        description: "URL to web code (zip recommended) or homepage"
        required: true
        default: "https://example.com/my-built-web.zip"
      VERSION_NAME:
        description: "Version name (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Version code (integer)"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target/compile SDK"
        required: true
        default: "35"
      ALLOW_MIXED_CONTENT:
        description: "Allow http:// content? true/false"
        required: true
        default: "false"
      PLUGINS:
        description: "Extra native plugins (none/camera/push/location/all)"
        required: true
        type: choice
        default: "none"
        options:
          - "none"
          - "camera"
          - "push"
          - "location"
          - "all"
      APP_ICON_URL:
        description: "Optional URL to icon (folder or direct png)"
        required: false
        default: ""
      SPLASH_SCREEN_URL:
        description: "Optional URL to splash (folder or direct png)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      MIN_SDK: "22"
      # keystore secrets from repo settings
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD:       ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS:               ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:            ${{ secrets.KEY_PASSWORD }}

      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID:   ${{ github.event.inputs.APP_ID }}
      WEB_URL:  ${{ github.event.inputs.WEB_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK:   ${{ github.event.inputs.TARGET_SDK }}
      ALLOW_MIXED_CONTENT: ${{ github.event.inputs.ALLOW_MIXED_CONTENT }}
      PLUGINS: ${{ github.event.inputs.PLUGINS }}
      APP_ICON_URL: ${{ github.event.inputs.APP_ICON_URL }}
      SPLASH_SCREEN_URL: ${{ github.event.inputs.SPLASH_SCREEN_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      #################################################################
      # 1) Prepare web build: repo build (dist/build/public) OR WEB_URL
      #################################################################
      - name: Prepare web build and set WEB_BUILD_DIR
        shell: bash
        run: |
          set -euo pipefail
          echo "Start Prepare web build"
          BUILD_DIR=""

          # prefer repo build (dist/build/public)
          if [ -f package.json ]; then
            echo "Found package.json - installing"
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
            if npm run | grep -q " build"; then npm run build || true; fi
            for d in dist build public; do
              if [ -d "$d" ]; then
                BUILD_DIR="$d"
                echo "Using repo build directory: $BUILD_DIR"
                break
              fi
            done
          fi

          # if not present, try WEB_URL
          if [ -z "$BUILD_DIR" ]; then
            echo "Repo build not found - using WEB_URL: ${WEB_URL}"
            mkdir -p downloaded_www
            if [[ "${ALLOW_MIXED_CONTENT}" != "true" && ! "${WEB_URL}" =~ ^https:// ]]; then
              echo "❌ WEB_URL must start with https:// (or set ALLOW_MIXED_CONTENT=true)"; exit 1
            fi

            # download zip if ends with .zip or content-type zip
            if [[ "${WEB_URL}" =~ \.zip$ ]]; then
              curl -fsSL "${WEB_URL}" -o /tmp/web_download.zip
              unzip -q /tmp/web_download.zip -d downloaded_www || true
            else
              CT=$(curl -fsSLI -o /dev/null -w '%{content_type}' "${WEB_URL}" || true)
              if [[ "${CT}" =~ zip ]]; then
                curl -fsSL "${WEB_URL}" -o /tmp/web_download.zip
                unzip -q /tmp/web_download.zip -d downloaded_www || true
              else
                # try wget mirror but warns for JS SPAs
                sudo apt-get update -y
                sudo apt-get install -y wget || true
                wget --mirror --no-parent --adjust-extension --convert-links --page-requisites --directory-prefix=downloaded_www --level=2 "${WEB_URL}" || true
              fi
            fi

            # find index.html
            FIRST_INDEX=$(find downloaded_www -type f -iname 'index.html' | head -n1 || true)
            if [ -n "$FIRST_INDEX" ]; then
              BUILD_DIR=$(dirname "$FIRST_INDEX")
              echo "Found index at: $FIRST_INDEX"
            else
              # fallback to common folders
              for d in downloaded_www/dist downloaded_www/build downloaded_www/public downloaded_www; do
                if [ -d "$d" ] && [ "$(ls -A "$d" 2>/dev/null | wc -l)" -gt 0 ]; then
                  BUILD_DIR="$d"
                  echo "Fallback using $BUILD_DIR"
                  break
                fi
              done
            fi
          fi

          if [ -z "$BUILD_DIR" ]; then
            mkdir -p minimal_www
            printf '<!doctype html><html><body style="font-family:sans-serif;text-align:center;padding-top:2rem;">No web build found. Provide a zip of built web files or include build in repo.</body></html>\n' > minimal_www/index.html
            BUILD_DIR="minimal_www"
            echo "Fell back to minimal_www"
          fi

          echo "WEB_BUILD_DIR will be: $BUILD_DIR"
          echo "WEB_BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

          # debug local list
          echo "=== BUILD_DIR listing ==="
          ls -la "$BUILD_DIR" || true

          # ensure capacitor deps
          npm install -D @capacitor/core @capacitor/cli @capacitor/android --no-audit --no-fund || true

      #################################################################
      # 2) Validate inputs & secrets
      #################################################################
      - name: Validate inputs & secrets
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! "${APP_ID}" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "❌ APP_ID invalid: ${APP_ID}"; exit 1
          fi
          if ! [[ "${VERSION_CODE}" =~ ^[0-9]+$ ]]; then
            echo "❌ VERSION_CODE must be integer"; exit 1
          fi
          for var in ANDROID_KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD; do
            if [ -z "${!var:-}" ]; then echo "❌ Missing secret: ${var}"; exit 1; fi
          done

      #################################################################
      # 3) Restore keystore
      #################################################################
      - name: Restore keystore from secret
        shell: bash
        run: |
          set -euo pipefail
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > android.keystore
          ls -l android.keystore || true

      #################################################################
      # 4) Configure Capacitor (bundle) + plugin install + cap sync
      #################################################################
      - name: Configure Capacitor (bundle) & sync
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${WEB_BUILD_DIR:-}" ]; then echo "WEB_BUILD_DIR empty - abort"; exit 1; fi
          echo "Init Capacitor"
          npx cap init "${APP_NAME}" "${APP_ID}" --web-dir="${WEB_BUILD_DIR}" || true

          printf '{\n' > capacitor.config.json
          printf '  "appId": "%s",\n' "${APP_ID}" >> capacitor.config.json
          printf '  "appName": "%s",\n' "${APP_NAME}" >> capacitor.config.json
          printf '  "webDir": "%s",\n' "${WEB_BUILD_DIR}" >> capacitor.config.json
          printf '  "bundledWebRuntime": false,\n' >> capacitor.config.json
          printf '  "android": {\n' >> capacitor.config.json
          if [ "${ALLOW_MIXED_CONTENT}" = "true" ]; then
            printf '    "allowMixedContent": true\n' >> capacitor.config.json
          else
            printf '    "allowMixedContent": false\n' >> capacitor.config.json
          fi
          printf '  }\n' >> capacitor.config.json
          printf '}\n' >> capacitor.config.json

          # optional plugins
          if [ "${PLUGINS}" = "camera" ]; then npm install @capacitor/camera || true; fi
          if [ "${PLUGINS}" = "push" ]; then npm install @capacitor/push-notifications || true; fi
          if [ "${PLUGINS}" = "location" ]; then npm install @capacitor/geolocation || true; fi
          if [ "${PLUGINS}" = "all" ]; then npm install @capacitor/camera @capacitor/push-notifications @capacitor/geolocation || true; fi

          npx cap add android || true
          npx cap sync android || true

      #################################################################
      # 5) FORCE COPY: put built web into all likely Android asset folders
      #################################################################
      - name: Force-copy web build into Android assets (all locations)
        shell: bash
        run: |
          set -euo pipefail
          SRC="$PWD/${WEB_BUILD_DIR:-}"
          echo "SRC = $SRC"
          if [ ! -d "$SRC" ]; then echo "❌ Source not found: $SRC"; exit 1; fi

          # possible destinations
          DST1="android/app/src/main/assets/public"
          DST2="android/app/src/main/assets/www"
          DST3="android/app/src/main/assets"

          for DST in "$DST1" "$DST2" "$DST3"; do
            echo "--- Copying to $DST ---"
            rm -rf "$DST"
            mkdir -p "$DST"
            if command -v rsync >/dev/null 2>&1; then
              rsync -a --delete "$SRC"/ "$DST"/
            else
              cp -a "$SRC"/. "$DST"/ || true
            fi
            echo "Listing $DST (top):"
            ls -la "$DST" | sed -n '1,200p' || true
          done

          # verify at least one index.html exists
          if ! ( [ -f "$DST1/index.html" ] || [ -f "$DST2/index.html" ] || [ -f "$DST3/index.html" ] ); then
            echo "⚠️ index.html not found in any asset location — app may show blank."
          else
            echo "✅ index.html present in asset(s)."
          fi

      #################################################################
      # 6) Apply branding assets (icons/splash) - same as before
      #################################################################
      - name: Apply branding assets (optional)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          ICON_SRC="${APP_ICON_URL:-}"
          SPLASH_SRC="${SPLASH_SCREEN_URL:-}"
          if [ -z "${ICON_SRC}" ] && [ -z "${SPLASH_SRC}" ]; then
            echo "No branding URLs provided — skipping."; exit 0
          fi

          dl() { url="$1"; out="$2"; curl -sfSL "$url" -o "$out" || true; }

          if [ -n "${ICON_SRC}" ]; then
            if [[ "${ICON_SRC}" =~ \.png$ ]]; then dl "${ICON_SRC}" /tmp/icon_src.png; else case "${ICON_SRC}" in */) ;; *) ICON_SRC="${ICON_SRC}/";; esac; dl "${ICON_SRC}icon_xxxhdpi.png" /tmp/icon_src.png; fi
          fi
          if [ -n "${SPLASH_SRC}" ]; then
            if [[ "${SPLASH_SRC}" =~ \.png$ ]]; then dl "${SPLASH_SRC}" /tmp/splash.png; else case "${SPLASH_SRC}" in */) ;; *) SPLASH_SRC="${SPLASH_SRC}/";; esac; dl "${SPLASH_SRC}splash.png" /tmp/splash.png; fi
          fi

          # generate resources (imagemagick best-effort)
          if [ -f /tmp/icon_src.png ]; then
            sudo apt-get update -y
            sudo apt-get install -y imagemagick || true
            convert /tmp/icon_src.png -background white -alpha remove -alpha off /tmp/icon_flat.png || cp /tmp/icon_src.png /tmp/icon_flat.png || true
            convert /tmp/icon_flat.png -resize 192x192\> /tmp/icon_xxxhdpi.png || true
            mkdir -p app/src/main/res/mipmap-xxxhdpi app/src/main/res/mipmap-xxhdpi app/src/main/res/mipmap-xhdpi app/src/main/res/mipmap-hdpi app/src/main/res/mipmap-anydpi-v26
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_foreground.png || true
            # background
            convert /tmp/icon_flat.png -resize 32x32\> /tmp/icon_bg.png || cp /tmp/icon_flat.png /tmp/icon_bg.png || true
            convert /tmp/icon_bg.png -background white -gravity center -extent 48x48 /tmp/icon_bg.png || true
            cp /tmp/icon_bg.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_background.png || true
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' '  <background android:drawable="@mipmap/ic_launcher_background"/>' '  <foreground android:drawable="@mipmap/ic_launcher_full"/>' '</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml || true
          fi

          if [ -f /tmp/splash.png ]; then
            sudo apt-get update -y
            sudo apt-get install -y imagemagick || true
            convert /tmp/splash.png -background white -alpha remove -alpha off /tmp/splash_flat.png || cp /tmp/splash.png /tmp/splash_flat.png || true
            mkdir -p app/src/main/res/drawable app/src/main/res/drawable-nodpi
            cp /tmp/splash_flat.png app/src/main/res/drawable-nodpi/splash.png || true
            cp /tmp/splash_flat.png app/src/main/res/drawable/splash.png || true
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<layer-list xmlns:android="http://schemas.android.com/apk/res/android">' '    <item android:drawable="@android:color/white" />' '    <item>' '        <bitmap android:gravity="center" android:src="@drawable/splash" />' '    </item>' '</layer-list>' > app/src/main/res/drawable/launch_background.xml || true
          fi

      #################################################################
      # 7) Ensure manifest has icon entries (ic_launcher_full)
      #################################################################
      - name: Ensure manifest icon entries
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          MF="app/src/main/AndroidManifest.xml"
          if [ -f "$MF" ]; then
            perl -0777 -pe '
              if (/<application\b[^>]*>/s) {
                $app=$&; $new=$app;
                if($new!~/android:icon=/){ $new=~s/<application/<application android:icon=\"\@mipmap\/ic_launcher_full\"/; } else { $new=~s/android:icon=\"[^\"]*\"/android:icon=\"\@mipmap\/ic_launcher_full\"/g; }
                if($new!~/android:roundIcon=/){ $new=~s/<application/<application android:roundIcon=\"\@mipmap\/ic_launcher_full\"/; } else { $new=~s/android:roundIcon=\"[^\"]*\"/android:roundIcon=\"\@mipmap\/ic_launcher_full\"/g; }
                s/\Q$app\E/$new/;
              }
            ' -i "$MF" || true
            sed -n '1,80p' "$MF" || true
          else
            echo "No AndroidManifest.xml found — skipping"
          fi

      #################################################################
      # 8) Patch Gradle (version, sdks, signing)
      #################################################################
      - name: Patch Gradle for versioning & signing
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          cp ../android.keystore app/release.keystore || true
          if [ -f app/build.gradle ]; then FILE="app/build.gradle"; else FILE="app/build.gradle.kts"; fi
          echo "Patching $FILE"
          sed -i -E "s/versionCode[ =]+[0-9]+/versionCode ${VERSION_CODE}/" "$FILE" || true
          sed -i -E "s/versionName[ =]+\"[^\"]+\"/versionName \"${VERSION_NAME}\"/" "$FILE" || true
          sed -i -E "s/minSdkVersion[ =]+[0-9]+/minSdkVersion ${MIN_SDK}/" "$FILE" || true
          sed -i -E "s/minSdk[ =]+[0-9]+/minSdk ${MIN_SDK}/" "$FILE" || true
          sed -i -E "s/targetSdkVersion[ =]+[0-9]+/targetSdkVersion ${TARGET_SDK}/" "$FILE" || true
          sed -i -E "s/targetSdk[ =]+[0-9]+/targetSdk ${TARGET_SDK}/" "$FILE" || true
          sed -i -E "s/compileSdkVersion[ =]+[0-9]+/compileSdkVersion ${TARGET_SDK}/" "$FILE" || true
          sed -i -E "s/compileSdk[ =]+[0-9]+/compileSdk ${TARGET_SDK}/" "$FILE" || true

          if ! grep -q "signingConfigs" "$FILE"; then
            {
              echo ""
              echo "android {"
              echo "  signingConfigs {"
              echo "    release {"
              echo "      storeFile file(\"release.keystore\")"
              echo "      storePassword System.getenv(\"KEYSTORE_PASSWORD\")"
              echo "      keyAlias System.getenv(\"KEY_ALIAS\")"
              echo "      keyPassword System.getenv(\"KEY_PASSWORD\")"
              echo "    }"
              echo "  }"
              echo "  buildTypes {"
              echo "    release {"
              echo "      signingConfig signingConfigs.release"
              echo "      minifyEnabled false"
              echo "      shrinkResources false"
              echo "      debuggable false"
              echo "    }"
              echo "  }"
              echo "}"
            } >> "$FILE"
          fi

      #################################################################
      # 9) Build release AAB + APK
      #################################################################
      - name: Build release AAB + APK
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          ./gradlew clean --no-daemon
          ./gradlew :app:bundleRelease :app:assembleRelease --no-daemon || true
          mkdir -p ../out_aab ../out_apk
          cp app/build/outputs/bundle/release/*.aab ../out_aab/ || true
          cp app/build/outputs/apk/release/*.apk ../out_apk/   || true
          echo "=== out_aab ==="; ls -la ../out_aab || true
          echo "=== out_apk ==="; ls -la ../out_apk || true

          # inspect apk(s) to confirm assets included
          if ls ../out_apk/*.apk 1> /dev/null 2>&1; then
            for A in ../out_apk/*.apk; do
              echo "---- Contents of $A ----"
              unzip -l "$A" | sed -n '1,200p' || true
              echo "---- Try extracting assets/index.html from $A ----"
              unzip -p "$A" "assets/public/index.html" 2>/dev/null | sed -n '1,80p' || true
              unzip -p "$A" "assets/www/index.html" 2>/dev/null | sed -n '1,80p' || true
              unzip -p "$A" "assets/index.html" 2>/dev/null | sed -n '1,80p' || true
            done
          fi

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: out_aab

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk
          path: out_apk
