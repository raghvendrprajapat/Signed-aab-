name: Build Web to Signed Android

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      WEB_URL:
        description: "Live URL (used if WEB_BUILD_DIR not provided)"
        required: false
        default: ""
      WEB_BUILD_DIR:
        description: "Prebuilt web folder inside repo (e.g. dist or build). Leave empty to fetch WEB_URL."
        required: false
        default: ""
      VERSION_CODE:
        description: "Android version code (integer)"
        required: false
        default: "1"
      VERSION_NAME:
        description: "Android version name"
        required: false
        default: "1.0.0"
      ALLOW_MIXED_CONTENT:
        description: "Set to true to allow http (not recommended)"
        required: false
        default: "false"
      PLUGINS:
        description: "Optional Capacitor plugins: camera|push|location|all"
        required: false
        default: ""
  push:
    branches:
      - main

jobs:
  build:
    name: Build signed AAB & APK (offline-ready)
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx1536m"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Restore keystore (from secret KEYSTORE_BASE64)
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        shell: bash
        run: |
          set -euo pipefail
          # write keystore file (will be moved into android app dir later)
          echo "$KEYSTORE_BASE64" | base64 -d > android/keystore.jks
          chmod 600 android/keystore.jks
          echo "Keystore written to android/keystore.jks"

      - name: Install dependencies
        run: |
          npm ci || npm install
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Prepare web assets (use WEB_BUILD_DIR if present, otherwise fetch WEB_URL)
        id: prepare_web
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ github.event.inputs.WEB_BUILD_DIR }}" ] && [ "${{ github.event.inputs.WEB_BUILD_DIR }}" != "" ]; then
            echo "Using repo web build dir: ${{ github.event.inputs.WEB_BUILD_DIR }}"
            echo "WEB_BUILD_DIR=${{ github.event.inputs.WEB_BUILD_DIR }}" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.WEB_URL }}" != "" ]; then
            echo "Fetching LIVE web site ${{ github.event.inputs.WEB_URL }} into minimal_www (best-effort)"
            mkdir -p minimal_www
            # best-effort fetch of main HTML — for full SPA bundling prefer building inside repo
            curl -sL --fail "${{ github.event.inputs.WEB_URL }}" -o minimal_www/index.html || true
            echo "WEB_BUILD_DIR=minimal_www" >> $GITHUB_ENV
          else
            echo "No WEB_BUILD_DIR or WEB_URL provided — expecting web content already in repo path 'www' or similar."
            echo "WEB_BUILD_DIR=www" >> $GITHUB_ENV
          fi

      - name: Configure Capacitor & Android project
        shell: bash
        run: |
          set -euo pipefail
          APP_ID="${{ github.event.inputs.APP_ID }}"
          APP_NAME="${{ github.event.inputs.APP_NAME }}"
          WEB_BUILD_DIR="${WEB_BUILD_DIR:-${{ github.event.inputs.WEB_BUILD_DIR }}}"
          if [ -z "$WEB_BUILD_DIR" ]; then WEB_BUILD_DIR="${WEB_BUILD_DIR:-minimal_www}"; fi
          cat > capacitor.config.json <<'CAPCONFIG'
{
  "appId": "__APP_ID_PLACEHOLDER__",
  "appName": "__APP_NAME_PLACEHOLDER__",
  "webDir": "__WEB_DIR_PLACEHOLDER__",
  "bundledWebRuntime": false
}
CAPCONFIG
          # Replace placeholders safely
          sed -i "s|__APP_ID_PLACEHOLDER__|${APP_ID}|g" capacitor.config.json
          sed -i "s|__APP_NAME_PLACEHOLDER__|${APP_NAME}|g" capacitor.config.json
          sed -i "s|__WEB_DIR_PLACEHOLDER__|${WEB_BUILD_DIR}|g" capacitor.config.json

          # Ensure Android platform exists and is synced
          npx cap add android || true
          npx cap sync android

      - name: Copy web assets into Android (ensures offline bundle)
        shell: bash
        run: |
          set -euo pipefail
          # This copies webDir into android/app/src/main/assets/public (Capacitor)
          npx cap copy android

      - name: Place keystore into android app dir & write gradle.properties signing config
        shell: bash
        run: |
          set -euo pipefail
          if [ -f android/keystore.jks ]; then
            # move keystore to android/app/
            mkdir -p android/app
            mv android/keystore.jks android/app/keystore.jks || true
            chmod 600 android/app/keystore.jks

            # Write gradle.properties (simple signing props)
            cat > android/gradle.properties <<EOF
RELEASE_STORE_FILE=keystore.jks
RELEASE_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}
RELEASE_KEY_ALIAS=${{ secrets.KEY_ALIAS }}
RELEASE_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
EOF
            echo "Keystore and signing properties written."
          else
            echo "No keystore found in android/keystore.jks — build will be unsigned unless you provide secrets."
          fi

      - name: Ensure gradlew is executable
        shell: bash
        run: |
          chmod +x android/gradlew || true

      - name: Build AAB and APK (release)
        shell: bash
        working-directory: android
        env:
          VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
          VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
        run: |
          set -euo pipefail
          ./gradlew clean --no-daemon
          # If keystore present in app/keystore.jks, pass signing props; Gradle script should read gradle.properties or injected props.
          if [ -f app/keystore.jks ]; then
            ./gradlew bundleRelease assembleRelease --no-daemon -Pandroid.injected.signing.store.file=app/keystore.jks -Pandroid.injected.signing.store.password="${{ secrets.KEYSTORE_PASSWORD }}" -Pandroid.injected.signing.key.alias="${{ secrets.KEY_ALIAS }}" -Pandroid.injected.signing.key.password="${{ secrets.KEY_PASSWORD }}"
          else
            echo "No keystore found — creating unsigned builds."
            ./gradlew bundleRelease assembleRelease --no-daemon || true
          fi
          ls -la app/build/outputs/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-artifacts
          path: |
            android/app/build/outputs/bundle/release/*.aab
            android/app/build/outputs/apk/release/*.apk

      - name: Final summary
        shell: bash
        run: |
          echo "Build finished. Artifacts uploaded as android-release-artifacts."
          if [ -f android/app/build/outputs/bundle/release/*.aab ]; then echo "AAB present"; fi
          if [ -f android/app/build/outputs/apk/release/*.apk ]; then echo "APK present"; fi
