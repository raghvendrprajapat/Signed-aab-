name: Build Web to Signed Android

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      WEB_URL:
        description: "Live URL (kept for reference; NOT used for bundled builds)"
        required: true
        default: "https://example.com"
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer. Must increase every Play upload"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target / compile SDK"
        required: true
        default: "35"
      PLUGINS:
        description: "Extra native plugins to include"
        required: true
        type: choice
        default: "none"
        options:
          - "none"
          - "camera"
          - "push"
          - "location"
          - "all"
      APP_ICON_URL:
        description: "Full URL to icon file OR public folder URL (optional)"
        required: false
        default: ""
      SPLASH_SCREEN_URL:
        description: "Full URL to splash file OR public folder URL (optional)"
        required: false
        default: ""
      PRIVACY_POLICY_URL:
        description: "Privacy policy URL (recommended if you show ads)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      WEB_URL: ${{ github.event.inputs.WEB_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      MIN_SDK: "22"
      PLUGINS: ${{ github.event.inputs.PLUGINS }}
      PRIVACY_POLICY_URL: ${{ github.event.inputs.PRIVACY_POLICY_URL }}

      KEYSTORE_BASE64:   ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java (match compile target)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare webDir (build web and set WEB_BUILD_DIR)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
            if npm run | grep -q " build"; then npm run build || true; fi
            for d in dist build public; do
              if [ -d "$d" ]; then echo "WEB_BUILD_DIR=$d" >> $GITHUB_ENV; break; fi
            done
          fi
          if ! grep -q WEB_BUILD_DIR $GITHUB_ENV 2>/dev/null; then
            mkdir -p minimal_www
            printf '<!doctype html><html><body style="font-family:sans-serif;text-align:center;padding-top:2rem;">Loading…</body></html>\n' > minimal_www/index.html
            echo "WEB_BUILD_DIR=minimal_www" >> $GITHUB_ENV
          fi
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! "$APP_ID" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "❌ APP_ID invalid: $APP_ID"; exit 1
          fi
          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then echo "❌ VERSION_CODE must be integer"; exit 1; fi
          if [ -z "${KEYSTORE_BASE64:-}" ] || [ -z "${KEYSTORE_PASSWORD:-}" ] || [ -z "${KEY_ALIAS:-}" ] || [ -z "${KEY_PASSWORD:-}" ]; then
            echo "❌ Missing keystore secrets. Set ANDROID_KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD"; exit 1
          fi
          if [ -z "${PRIVACY_POLICY_URL:-}" ]; then
            echo "⚠️ PRIVACY_POLICY_URL not provided. Recommended if you show ads or collect data."
          fi

      - name: Restore keystore (safe)
        shell: bash
        run: |
          set -euo pipefail
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
          chmod 600 android.keystore

      - name: Configure Capacitor (bundle web assets inside app — NO server.url)
        shell: bash
        run: |
          set -euo pipefail
          echo "WEB_BUILD_DIR currently set to: $WEB_BUILD_DIR"

          if [ ! -d "$WEB_BUILD_DIR" ] || [ -z "$(ls -A "$WEB_BUILD_DIR" 2>/dev/null || true)" ]; then
            echo "❌ WEB_BUILD_DIR ($WEB_BUILD_DIR) missing or empty. Build your web app first."
            ls -la || true
            exit 1
          fi

          npx cap init "$APP_NAME" "$APP_ID" --web-dir="$WEB_BUILD_DIR" || true

          # create capacitor.config.json safely using printf (avoid heredoc / YAML parser issues)
          printf '{\n' > capacitor.config.json
          printf '  "appId": "%s",\n' "$APP_ID" >> capacitor.config.json
          printf '  "appName": "%s",\n' "$APP_NAME" >> capacitor.config.json
          printf '  "webDir": "%s",\n' "$WEB_BUILD_DIR" >> capacitor.config.json
          printf '  "bundledWebRuntime": false,\n' >> capacitor.config.json
          printf '  "android": {\n' >> capacitor.config.json
          printf '    "allowMixedContent": false\n' >> capacitor.config.json
          printf '  }\n' >> capacitor.config.json
          printf '}\n' >> capacitor.config.json

          if [ "$PLUGINS" = "camera" ]; then npm install @capacitor/camera
          elif [ "$PLUGINS" = "push" ]; then npm install @capacitor/push-notifications
          elif [ "$PLUGINS" = "location" ]; then npm install @capacitor/geolocation
          elif [ "$PLUGINS" = "all" ]; then npm install @capacitor/camera @capacitor/push-notifications @capacitor/geolocation
          fi

          npx cap add android || true
          npx cap copy android
          npx cap sync android

          if [ -f android/app/src/main/assets/public/index.html ]; then
            echo "✅ Bundled web assets present in android/app/src/main/assets/public"
            ls -la android/app/src/main/assets/public | sed -n '1,200p' || true
          else
            echo "❌ Bundled web assets NOT found at android/app/src/main/assets/public — build will fail"
            ls -la android/app/src/main/assets || true
            exit 1
          fi

      - name: Apply branding assets (ensure fallback splash/icon)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          ICON_SRC="${{ github.event.inputs.APP_ICON_URL }}"
          SPLASH_SRC="${{ github.event.inputs.SPLASH_SCREEN_URL }}"

          if [ -z "$ICON_SRC" ] && [ -z "$SPLASH_SRC" ]; then
            sudo apt-get update -y
            sudo apt-get install -y imagemagick || true
            convert -size 192x192 xc:white /tmp/icon_src.png || printf "" > /tmp/icon_src.png
            convert -size 720x1280 xc:white /tmp/splash.png || printf "" > /tmp/splash.png
          fi

          dl() { url="$1"; out="$2"; curl -sfSL "$url" -o "$out" || true; }

          if [ -n "$ICON_SRC" ]; then
            if [[ "$ICON_SRC" =~ \.png$ ]]; then dl "$ICON_SRC" /tmp/icon_src.png; else dl "${ICON_SRC%/}/icon_xxxhdpi.png" /tmp/icon_src.png || dl "${ICON_SRC%/}/icon.png" /tmp/icon_src.png || true; fi
          fi

          if [ -n "$SPLASH_SRC" ]; then
            if [[ "$SPLASH_SRC" =~ \.png$ ]]; then dl "$SPLASH_SRC" /tmp/splash.png; else dl "${SPLASH_SRC%/}/splash.png" /tmp/splash.png || true; fi
          fi

          rm -rf app/src/main/res/mipmap-* app/src/main/res/drawable* app/src/main/res/mipmap-anydpi-v26 || true
          mkdir -p app/src/main/res/mipmap-xxxhdpi app/src/main/res/mipmap-xxhdpi app/src/main/res/mipmap-xhdpi app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-anydpi-v26
          mkdir -p app/src/main/res/drawable app/src/main/res/drawable-nodpi

          if [ -f /tmp/icon_src.png ]; then
            sudo apt-get install -y imagemagick || true
            convert /tmp/icon_src.png -background white -alpha remove -alpha off /tmp/icon_flat.png || cp /tmp/icon_src.png /tmp/icon_flat.png || true
            convert /tmp/icon_flat.png -resize 192x192\> /tmp/icon_xxxhdpi.png || true
            convert /tmp/icon_flat.png -resize 144x144\> /tmp/icon_xxhdpi.png || true
            convert /tmp/icon_flat.png -resize 96x96\> /tmp/icon_xhdpi.png || true
            convert /tmp/icon_flat.png -resize 72x72\> /tmp/icon_hdpi.png || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher_full.png
