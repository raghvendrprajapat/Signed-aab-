name: Build Web to Signed Android

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      WEB_URL:
        description: "Live URL (must be https:// unless you allow http)"
        required: true
        default: "https://example.com"
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer. Must increase every Play upload"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target / compile SDK"
        required: true
        default: "35"
      ALLOW_MIXED_CONTENT:
        description: "Allow http:// content? true/false"
        required: true
        default: "false"
      PLUGINS:
        description: "Extra native plugins to include"
        required: true
        type: choice
        default: "none"
        options:
          - "none"
          - "camera"
          - "push"
          - "location"
          - "all"
      APP_ICON_URL:
        description: "Public folder URL that contains app icon PNGs (optional)"
        required: false
        default: ""
      SPLASH_SCREEN_URL:
        description: "Public folder URL for splash screen PNG (optional)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      WEB_URL: ${{ github.event.inputs.WEB_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      # MIN_SDK kept as default 22
      MIN_SDK: "22"
      ALLOW_MIXED_CONTENT: ${{ github.event.inputs.ALLOW_MIXED_CONTENT }}
      PLUGINS: ${{ github.event.inputs.PLUGINS }}

      # secrets (must exist in repo → Settings → Secrets and variables → Actions)
      KEYSTORE_BASE64:   ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      #################################################################
      # 1. Prepare webDir (works with OR without package.json)
      #################################################################
      - name: Prepare webDir
        shell: bash
        run: |
          set -euo pipefail

          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

            if npm run | grep -q " build"; then
              npm run build || true
            fi

            for d in dist build public; do
              if [ -d "$d" ]; then
                echo "WEB_BUILD_DIR=$d" >> $GITHUB_ENV
                break
              fi
            done
          fi

          if ! grep -q WEB_BUILD_DIR $GITHUB_ENV 2>/dev/null; then
            mkdir -p minimal_www
            printf '<!doctype html><html><body style="font-family:sans-serif;text-align:center;padding-top:2rem;">Loading…</body></html>\n' > minimal_www/index.html
            echo "WEB_BUILD_DIR=minimal_www" >> $GITHUB_ENV
          fi

          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      #################################################################
      # 2. Validate inputs + secrets before wasting time
      #################################################################
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! "$APP_ID" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "❌ APP_ID invalid: $APP_ID"
            exit 1
          fi

          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            echo "❌ VERSION_CODE must be integer"
            exit 1
          fi

          if [[ "$ALLOW_MIXED_CONTENT" != "true" && ! "$WEB_URL" =~ ^https:// ]]; then
            echo "❌ WEB_URL must start with https:// (or set ALLOW_MIXED_CONTENT=true)"
            exit 1
          fi

          for var in KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD; do
            if [ -z "${!var:-}" ]; then
              echo "❌ Missing secret: $var"
              exit 1
            fi
          done

      #################################################################
      # 3. Restore keystore from Base64
      #################################################################
      - name: Restore keystore
        shell: bash
        run: |
          set -euo pipefail
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
          ls -l android.keystore

      #################################################################
      # 4. Init Capacitor project and generate capacitor.config.json
      #################################################################
      - name: Configure Capacitor
        shell: bash
        run: |
          set -euo pipefail
          echo "WEB_BUILD_DIR currently set to: $WEB_BUILD_DIR"
          npx cap init "$APP_NAME" "$APP_ID" --web-dir="$WEB_BUILD_DIR" || true

          printf '{\n' > capacitor.config.json
          printf '  "appId": "%s",\n' "$APP_ID" >> capacitor.config.json
          printf '  "appName": "%s",\n' "$APP_NAME" >> capacitor.config.json
          printf '  "webDir": "%s",\n' "$WEB_BUILD_DIR" >> capacitor.config.json
          printf '  "bundledWebRuntime": false,\n' >> capacitor.config.json
          printf '  "server": {\n' >> capacitor.config.json
          printf '    "url": "%s",\n' "$WEB_URL" >> capacitor.config.json
          if [ "$ALLOW_MIXED_CONTENT" = "true" ]; then
            printf '    "cleartext": true\n' >> capacitor.config.json
          else
            printf '    "cleartext": false\n' >> capacitor.config.json
          fi
          printf '  },\n' >> capacitor.config.json
          printf '  "android": {\n' >> capacitor.config.json
          if [ "$ALLOW_MIXED_CONTENT" = "true" ]; then
            printf '    "allowMixedContent": true\n' >> capacitor.config.json
          else
            printf '    "allowMixedContent": false\n' >> capacitor.config.json
          fi
          printf '  }\n' >> capacitor.config.json
          printf '}\n' >> capacitor.config.json

          if [ "$PLUGINS" = "camera" ]; then
            npm install @capacitor/camera
          elif [ "$PLUGINS" = "push" ]; then
            npm install @capacitor/push-notifications
          elif [ "$PLUGINS" = "location" ]; then
            npm install @capacitor/geolocation
          elif [ "$PLUGINS" = "all" ]; then
            npm install @capacitor/camera @capacitor/push-notifications @capacitor/geolocation
          fi

          npx cap add android || true
          npx cap sync android

      #################################################################
      # 4.5 Apply branding assets from URL(s) (if provided) + ImageMagick
      # This step converts input PNG to proper square icons and adaptive
      #################################################################
      - name: Apply branding assets from URL(s) (if provided)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail

          ICON_SRC="${{ github.event.inputs.APP_ICON_URL }}"
          SPLASH_SRC="${{ github.event.inputs.SPLASH_SCREEN_URL }}"

          if [ -z "$ICON_SRC" ] && [ -z "$SPLASH_SRC" ]; then
            echo "No branding URLs provided — skipping branding download"
            exit 0
          fi

          # install imagemagick for processing icons
          sudo apt-get update -y
          sudo apt-get install -y imagemagick || true

          # normalize icon src / splash src (allow either folder or direct file URL)
          if [ -n "$ICON_SRC" ]; then
            case "$ICON_SRC" in */) ;; *) ICON_SRC="$ICON_SRC/";; esac
            echo "Downloading icons from: $ICON_SRC"
            curl -sfSL "${ICON_SRC}icon_xxxhdpi.png" -o /tmp/icon_xxxhdpi.png || true
            curl -sfSL "${ICON_SRC}icon_xxhdpi.png"  -o /tmp/icon_xxhdpi.png  || true
            curl -sfSL "${ICON_SRC}icon_xhdpi.png"   -o /tmp/icon_xhdpi.png   || true
            curl -sfSL "${ICON_SRC}icon_hdpi.png"    -o /tmp/icon_hdpi.png    || true
            # fallback: if user supplied direct file URL (not folder), try downloading that single file
            if [ ! -f /tmp/icon_xxxhdpi.png ]; then
              echo "Trying ICON_SRC as direct file: ${ICON_SRC%/}"
              curl -sfSL "${ICON_SRC%/}" -o /tmp/icon_xxxhdpi.png || true
            fi
          fi

          if [ -n "$SPLASH_SRC" ]; then
            case "$SPLASH_SRC" in */) ;; *) SPLASH_SRC="$SPLASH_SRC/";; esac
            echo "Downloading splash from: $SPLASH_SRC"
            curl -sfSL "${SPLASH_SRC}splash.png" -o /tmp/splash.png || true
            if [ ! -f /tmp/splash.png ]; then
              echo "Trying SPLASH_SRC as direct file: ${SPLASH_SRC%/}"
              curl -sfSL "${SPLASH_SRC%/}" -o /tmp/splash.png || true
            fi
          fi

          # choose source icon to process (prefer the xxxhdpi if present, else any downloaded)
          ICON_SOURCE=""
          if [ -f /tmp/icon_xxxhdpi.png ]; then
            ICON_SOURCE="/tmp/icon_xxxhdpi.png"
          elif [ -f /tmp/icon_xxhdpi.png ]; then
            ICON_SOURCE="/tmp/icon_xxhdpi.png"
          elif [ -f /tmp/icon_xhdpi.png ]; then
            ICON_SOURCE="/tmp/icon_xhdpi.png"
          elif [ -f /tmp/icon_hdpi.png ]; then
            ICON_SOURCE="/tmp/icon_hdpi.png"
          fi

          # If a source exists, create properly sized square icons + adaptive foreground
          if [ -n "$ICON_SOURCE" ]; then
            echo "Processing icon with ImageMagick from $ICON_SOURCE"

            # create a square centered base (1024x1024) preserving transparency
            convert "$ICON_SOURCE" -resize 1024x1024^ -gravity center -background none -extent 1024x1024 /tmp/icon_base.png || true

            # generate densities: xxxhdpi=192, xxhdpi=144, xhdpi=96, hdpi=72
            convert /tmp/icon_base.png -resize 192x192 /tmp/icon_xxxhdpi.png || true
            convert /tmp/icon_base.png -resize 144x144 /tmp/icon_xxhdpi.png || true
            convert /tmp/icon_base.png -resize 96x96   /tmp/icon_xhdpi.png  || true
            convert /tmp/icon_base.png -resize 72x72   /tmp/icon_hdpi.png   || true

            # create adaptive foreground (centered, recommended size 432x432)
            convert /tmp/icon_base.png -resize 432x432 /tmp/ic_launcher_foreground.png || true
          else
            echo "No icon source to process."
          fi

          # create resource dirs (safe)
          mkdir -p app/src/main/res/mipmap-xxxhdpi app/src/main/res/mipmap-xxhdpi app/src/main/res/mipmap-xhdpi app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-anydpi-v26
          mkdir -p app/src/main/res/drawable app/src/main/res/drawable-nodpi

          # copy processed (or downloaded) icons to proper places
          if [ -f /tmp/icon_xxxhdpi.png ]; then
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png || true
            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png || true
            cp /tmp/icon_xxhdpi.png  app/src/main/res/mipmap-xxhdpi/ic_launcher.png || true
            cp /tmp/icon_xhdpi.png   app/src/main/res/mipmap-xhdpi/ic_launcher.png || true
            cp /tmp/icon_hdpi.png    app/src/main/res/mipmap-hdpi/ic_launcher.png || true
          fi

          # copy adaptive foreground if created
          if [ -f /tmp/ic_launcher_foreground.png ]; then
            cp /tmp/ic_launcher_foreground.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_foreground.png || true
            # create a simple white background drawable for adaptive icon
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' \
              '<shape xmlns:android="http://schemas.android.com/apk/res/android" android:shape="rectangle">' \
              '  <solid android:color="#FFFFFF"/>' \
              '</shape>' > app/src/main/res/drawable/ic_launcher_background.xml || true

            # adaptive icon xml
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' \
              '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' \
              '  <background android:drawable="@drawable/ic_launcher_background"/>' \
              '  <foreground android:drawable="@mipmap/ic_launcher_foreground"/>' \
              '</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml || true

            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' \
              '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' \
              '  <background android:drawable="@drawable/ic_launcher_background"/>' \
              '  <foreground android:drawable="@mipmap/ic_launcher_foreground"/>' \
              '</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml || true
          fi

          # --- splash handling ---
          if [ -f /tmp/splash.png ]; then
            echo "Installing splash image..."
            cp /tmp/splash.png app/src/main/res/drawable-nodpi/splash.png || true

            LAUNCH_XML="app/src/main/res/drawable/launch_background.xml"
            if [ -f "$LAUNCH_XML" ]; then
              if ! grep -q "@drawable/splash" "$LAUNCH_XML" 2>/dev/null; then
                printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' \
                  '<layer-list xmlns:android="http://schemas.android.com/apk/res/android">' \
                  '    <item android:drawable="@android:color/white" />' \
                  '    <item>' \
                  '        <bitmap android:gravity="center" android:src="@drawable/splash" />' \
                  '    </item>' \
                  '</layer-list>' > "$LAUNCH_XML" || true
              fi
            else
              mkdir -p app/src/main/res/drawable
              printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' \
                '<layer-list xmlns:android="http://schemas.android.com/apk/res/android">' \
                '    <item android:drawable="@android:color/white" />' \
                '    <item>' \
                '        <bitmap android:gravity="center" android:src="@drawable/splash" />' \
                '    </item>' \
                '</layer-list>' > "$LAUNCH_XML" || true
            fi
            echo "Splash applied and launch_background updated/created."
          else
            echo "No /tmp/splash.png found — splash not applied."
          fi

          # debug info
          echo "=== DEBUG: /tmp files ==="
          ls -l /tmp/icon_* /tmp/ic_launcher_foreground.png /tmp/splash.png || true
          echo "=== DEBUG: mipmap-anydpi-v26 ==="
          ls -l app/src/main/res/mipmap-anydpi-v26 || true
          echo "=== DEBUG: mipmap-* folders ==="
          ls -l app/src/main/res/mipmap-* | sed -n '1,200p' || true
          echo "=== DEBUG: drawable folders ==="
          ls -l app/src/main/res/drawable* | sed -n '1,200p' || true
          echo "Branding step complete."

      #################################################################
      # 5. Patch Gradle for versioning, SDK levels, signing
      #################################################################
      - name: Patch Gradle
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          cp ../android.keystore app/release.keystore

          if [ -f app/build.gradle ]; then
            FILE="app/build.gradle"
          else
            FILE="app/build.gradle.kts"
          fi

          echo "Patching $FILE"

          sed -i -E "s/versionCode[ =]+[0-9]+/versionCode $VERSION_CODE/" "$FILE" || true
          sed -i -E "s/versionName[ =]+\"[^\"]+\"/versionName \"$VERSION_NAME\"/" "$FILE" || true

          sed -i -E "s/minSdkVersion[ =]+[0-9]+/minSdkVersion $MIN_SDK/" "$FILE" || true
          sed -i -E "s/minSdk[ =]+[0-9]+/minSdk $MIN_SDK/" "$FILE" || true

          sed -i -E "s/targetSdkVersion[ =]+[0-9]+/targetSdkVersion $TARGET_SDK/" "$FILE" || true
          sed -i -E "s/targetSdk[ =]+[0-9]+/targetSdk $TARGET_SDK/" "$FILE" || true

          sed -i -E "s/compileSdkVersion[ =]+[0-9]+/compileSdkVersion $TARGET_SDK/" "$FILE" || true
          sed -i -E "s/compileSdk[ =]+[0-9]+/compileSdk $TARGET_SDK/" "$FILE" || true

          if ! grep -q "signingConfigs" "$FILE"; then
            {
              echo ""
              echo "android {"
              echo "    signingConfigs {"
              echo "        release {"
              echo "            storeFile file(\"release.keystore\")"
              echo "            storePassword System.getenv(\"KEYSTORE_PASSWORD\")"
              echo "            keyAlias      System.getenv(\"KEY_ALIAS\")"
              echo "            keyPassword   System.getenv(\"KEY_PASSWORD\")"
              echo "        }"
              echo "    }"
              echo "    buildTypes {"
              echo "        release {"
              echo "            signingConfig signingConfigs.release"
              echo "            minifyEnabled false"
              echo "            shrinkResources false"
              echo "            debuggable false"
              echo "        }"
              echo "    }"
              echo "}"
            } >> "$FILE"
          fi

          if [ "$ALLOW_MIXED_CONTENT" = "true" ]; then
            MF="app/src/main/AndroidManifest.xml"
            if [ -f "$MF" ]; then
              if ! grep -q usesCleartextTraffic "$MF"; then
                sed -i 's/<application /<application android:usesCleartextTraffic="true" /' "$MF"
              fi
            fi
          fi

      #################################################################
      # 6. Build release AAB+APK and upload artifacts separately
      #################################################################
      - name: Build release
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          ./gradlew clean :app:bundleRelease :app:assembleRelease

          mkdir -p ../out_aab
          mkdir -p ../out_apk

          cp app/build/outputs/bundle/release/*.aab ../out_aab/ || true
          cp app/build/outputs/apk/release/*.apk ../out_apk/   || true

          echo "=== AAB files ==="
          ls -l ../out_aab || true
          echo "=== APK files ==="
          ls -l ../out_apk || true

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: out_aab

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk
          path: out_apk
