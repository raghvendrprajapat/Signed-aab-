name: Build Web to Signed Android (Optimized)

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App display name"
        required: false
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer. Must increase every Play upload"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target / compile SDK (e.g. 35)"
        required: true
        default: "35"
      WEB_BUNDLE:
        description: "Bundle web assets inside app? (true/false)"
        required: true
        type: choice
        default: "true"
        options:
          - "true"
          - "false"
      PLUGINS:
        description: "Extra native plugins (none|camera|push|location|all)"
        required: true
        type: choice
        default: "none"
        options:
          - "none"
          - "camera"
          - "push"
          - "location"
          - "all"
      APP_ICON_URL:
        description: "Optional: URL to icon PNG (1024x1024)"
        required: false
        default: ""
      SPLASH_SCREEN_URL:
        description: "Optional: URL to splash PNG (1280x1280)"
        required: false
        default: ""
      PRIVACY_POLICY_URL:
        description: "Optional: privacy policy URL (Required for Play Console)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      WEB_BUNDLE: ${{ github.event.inputs.WEB_BUNDLE }}
      PLUGINS: ${{ github.event.inputs.PLUGINS }}
      APP_ICON_URL: ${{ github.event.inputs.APP_ICON_URL }}
      SPLASH_SCREEN_URL: ${{ github.event.inputs.SPLASH_SCREEN_URL }}
      PRIVACY_POLICY_URL: ${{ github.event.inputs.PRIVACY_POLICY_URL }}
      MIN_SDK: "22"
      KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      CI: "true" # For npm ci

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v3

      - name: Set up Java 17 (with cache)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: 'gradle' # Cache Gradle dependencies

      - name: Set up Node 18 (with cache)
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm' # Cache npm packages

      - name: Prepare webDir (build web if present)
        shell: bash
        run: |
          set -euo pipefail
          echo "Preparing web build dir"
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
            if npm run | grep -q " build"; then npm run build; fi
          fi
          WEB_BUILD_DIR=""
          for d in dist build public; do
            if [ -d "$d" ]; then WEB_BUILD_DIR="$d"; break; fi
          done
          if [ -z "$WEB_BUILD_DIR" ]; then
            mkdir -p minimal_www
            printf '<!doctype html><html><body style="font-family:sans-serif;text-align:center;padding-top:2rem;">Loading…</body></html>\n' > minimal_www/index.html
            WEB_BUILD_DIR="minimal_www"
          fi
          echo "WEB_BUILD_DIR=${WEB_BUILD_DIR}" >> $GITHUB_ENV
          echo "Using web build dir: ${WEB_BUILD_DIR}"

      - name: Validate inputs & secrets
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! "${APP_ID}" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "ERROR: APP_ID invalid: ${APP_ID}"; exit 1
          fi
          if ! [[ "${VERSION_CODE}" =~ ^[0-9]+$ ]]; then
            echo "ERROR: VERSION_CODE must be integer"; exit 1
          fi
          if [ -z "${KEYSTORE_BASE64:-}" ] || [ -z "${KEYSTORE_PASSWORD:-}" ] || [ -z "${KEY_ALIAS:-}" ] || [ -z "${KEY_PASSWORD:-}" ]; then
            echo "ERROR: Missing keystore secrets. Set ANDROID_KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD"; exit 1
          fi
          echo "✅ inputs & secrets ok"

      - name: Restore keystore
        shell: bash
        run: |
          set -euo pipefail
          echo "${KEYSTORE_BASE64}" | base64 -d > android.keystore
          chmod 600 android.keystore

      - name: Install Capacitor dev packages
        shell: bash
        run: |
          set -euo pipefail
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Configure Capacitor
        shell: bash
        run: |
          set -euo pipefail
          WEB_DIR="${WEB_BUILD_DIR:-minimal_www}"
          npx cap init "${APP_NAME}" "${APP_ID}" --web-dir="${WEB_DIR}"
          
          # Write config file dynamically
          printf '{\n' > capacitor.config.json
          printf '  "appId": "%s",\n' "${APP_ID}" >> capacitor.config.json
          printf '  "appName": "%s",\n' "${APP_NAME}" >> capacitor.config.json
          printf '  "webDir": "%s",\n' "${WEB_DIR}" >> capacitor.config.json
          printf '  "bundledWebRuntime": %s\n' "${WEB_BUNDLE}" >> capacitor.config.json # <-- FIXED
          printf '}\n' >> capacitor.config.json

          if [ "${PLUGINS}" = "camera" ]; then npm i @capacitor/camera; fi
          if [ "${PLUGINS}" = "push" ]; then npm i @capacitor/push-notifications; fi
          if [ "${PLUGINS}" = "location" ]; then npm i @capacitor/geolocation; fi
          if [ "${PLUGINS}" = "all" ]; then npm i @capacitor/camera @capacitor/push-notifications @capacitor/geolocation; fi

          npx cap add android
          npx cap copy android
          npx cap sync android

      - name: Apply branding assets (safe fallbacks)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          ICON_SRC="${APP_ICON_URL:-}"
          SPLASH_SRC="${SPLASH_SCREEN_URL:-}"
          rm -rf app/src/main/res/mipmap-* app/src/main/res/drawable* app/src/main/res/mipmap-anydpi-v26 || true
          mkdir -p app/src/main/res/mipmap-xxxhdpi app/src/main/res/mipmap-xxhdpi app/src/main/res/mipmap-xhdpi app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-anydpi-v26 app/src/main/res/drawable app/src/main/res/drawable-nodpi

          dl() { url="$1"; out="$2"; curl -sfSL "$url" -o "$out" || true; }

          if [ -n "$ICON_SRC" ]; then
            if [[ "$ICON_SRC" =~ \.png$ ]]; then dl "$ICON_SRC" /tmp/icon_src.png; else dl "${ICON_SRC%/}/icon_xxxhdpi.png" /tmp/icon_src.png || true; fi
          fi
          if [ -f /tmp/icon_src.png ]; then
            sudo apt-get update -y >/dev/null || true
            sudo apt-get install -y imagemagick >/dev/null || true
            convert /tmp/icon_src.png -background white -alpha remove -alpha off /tmp/icon_flat.png || cp /tmp/icon_src.png /tmp/icon_flat.png || true
            convert /tmp/icon_flat.png -resize 192x192\> /tmp/icon_xxxhdpi.png || cp /tmp/icon_flat.png /tmp/icon_xxxhdpi.png || true
            convert /tmp/icon_flat.png -resize 144x144\> /tmp/icon_xxhdpi.png || cp /tmp/icon_flat.png /tmp/icon_xxhdpi.png || true
            convert /tmp/icon_flat.png -resize 96x96\> /tmp/icon_xhdpi.png || cp /tmp/icon_flat.png /tmp/icon_xhdpi.png || true
            convert /tmp/icon_flat.png -resize 72x72\> /tmp/icon_hdpi.png || cp /tmp/icon_flat.png /tmp/icon_hdpi.png || true

            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher_full.png || true
            cp /tmp/icon_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher_full.png || true
            cp /tmp/icon_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher_full.png || true

            cp /tmp/icon_xxxhdpi.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_foreground.png || true
            convert /tmp/icon_flat.png -resize 48x48\> /tmp/icon_bg.png || cp /tmp/icon_flat.png /tmp/icon_bg.png || true
            cp /tmp/icon_bg.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_background.png || true
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">' '  <background android:drawable="@mipmap/ic_launcher_background"/>' '  <foreground android:drawable="@mipmap/ic_launcher_full"/>' '</adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml || true
          fi

          if [ -n "$SPLASH_SRC" ]; then
            if [[ "$SPLASH_SRC" =~ \.png$ ]]; then dl "$SPLASH_SRC" /tmp/splash.png; else dl "${SPLASH_SRC%/}/splash.png" /tmp/splash.png || true; fi
          fi
          if [ -f /tmp/splash.png ]; then
            sudo apt-get update -y >/dev/null || true
            sudo apt-get install -y imagemagick >/dev/null || true
            convert /tmp/splash.png -background white -alpha remove -alpha off /tmp/splash_flat.png || cp /tmp/splash.png /tmp/splash_flat.png || true
            cp /tmp/splash_flat.png app/src/main/res/drawable-nodpi/splash.png || true
            cp /tmp/splash_flat.png app/src/main/res/drawable/splash.png || true
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' '<layer-list xmlns:android="http://schemas.android.com/apk/res/android">' '  <item android:drawable="@android:color/white"/>' '  <item>' '    <bitmap android:gravity="center" android:src="@drawable/splash"/>' '  </item>' '</layer-list>' > app/src/main/res/drawable/launch_background.xml || true
          fi

      - name: Patch AndroidManifest.xml
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          MF="app/src/main/AndroidManifest.xml"
          if [ -f "$MF" ]; then
            # Add INTERNET permission if missing
            if ! grep -q "android.permission.INTERNET" "$MF"; then
              sed -i '/<manifest/a \    <uses-permission android:name="android.permission.INTERNET" />' "$MF" || true
            fi
            
            # Ensure icons are set
            perl -0777 -pe '
              if (/<application\b[^>]*>/s) {
                $app = $&; $new = $app;
                if ($new !~ /android:icon=/) { $new =~ s/<application/<application android:icon=\"\@mipmap\/ic_launcher_full\"/; }
                else { $new =~ s/android:icon=\"[^\"]*\"/android:icon=\"\@mipmap\/ic_launcher_full\"/g; }
                if ($new !~ /android:roundIcon=/) { $new =~ s/<application/<application android:roundIcon=\"\@mipmap\/ic_launcher_full\"/; }
                else { $new =~ s/android:roundIcon=\"[^\"]*\"/android:roundIcon=\"\@mipmap\/ic_launcher_full\"/g; }
                s/\Q$app\E/$new/;
              }
            ' -i "$MF" || true
          fi

      - name: Create default ProGuard rules for Capacitor
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          mkdir -p app
          printf '%s\n' \
            '# Capacitor ProGuard rules' \
            '-keep class * extends com.getcapacitor.JSObject { *; }' \
            '-keep class * extends com.getcapacitor.Plugin { *; }' \
            '-keep public class com.getcapacitor.plugin.CapacitorHttp { *; }' \
            '-keep public class com.getcapacitor.plugin.WebView { *; }' \
            '-keep public class * implements java.io.Serializable { *; }' \
            '# Add rules for any custom plugins here' \
            > app/proguard-rules.pro
          echo "✅ Created app/proguard-rules.pro"

      - name: Patch Gradle (Optimize & Sign)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          cp ../android.keystore app/release.keystore || true
          FILE=""
          if [ -f app/build.gradle ]; then FILE="app/build.gradle"; elif [ -f app/build.gradle.kts ]; then FILE="app/build.gradle.kts"; fi
          if [ -n "$FILE" ]; then
            sed -i -E "s/versionCode[ =]+[0-9]+/versionCode ${VERSION_CODE}/" "$FILE" || true
            sed -i -E "s/versionName[ =]+\"[^\"]+\"/versionName \"${VERSION_NAME}\"/" "$FILE" || true
            sed -i -E "s/minSdkVersion[ =]+[0-9]+/minSdkVersion ${MIN_SDK}/" "$FILE" || true
            sed -i -E "s/targetSdkVersion[ =]+[0-9]+/targetSdkVersion ${TARGET_SDK}/" "$FILE" || true
            sed -i -E "s/compileSdkVersion[ =]+[0-9]+/compileSdkVersion ${TARGET_SDK}/" "$FILE" || true
            if ! grep -q "signingConfigs" "$FILE"; then
              printf '\nandroid {\n  signingConfigs {\n    release {\n      storeFile file("release.keystore")\n      storePassword System.getenv("KEYSTORE_PASSWORD")\n      keyAlias System.getenv("KEY_ALIAS")\n      keyPassword System.getenv("KEY_PASSWORD")\n    }\n  }\n  buildTypes {\n    release {\n      signingConfig signingConfigs.release\n      minifyEnabled true\n      shrinkResources true\n      debuggable false\n      proguardFiles getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro"\n    }\n  }\n}\n' >> "$FILE" || true
            fi
            echo "✅ Patched $FILE for signing and optimization"
          fi

      - name: Make gradlew executable
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          chmod +x gradlew || true

      - name: Build Release AAB (and APK)
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          echo "Starting gradle build..."
          ./gradlew clean --no-daemon
          # Build both AAB (bundle) for Play Store and APK for testing
          ./gradlew :app:bundleRelease :app:assembleRelease --no-daemon

          # prepare out folders
          mkdir -p ../out_aab ../out_apk

          echo "Searching for AAB files..."
          AAB_FOUND=0
          while IFS= read -r -d '' f; do
            cp "$f" ../out_aab/ || true
            echo "Copied AAB: $f"
            AAB_FOUND=1
          done < <(find app/build/outputs -type f -name "*.aab" -print0 || true)

          echo "Searching for APK files..."
          while IFS= read -r -d '' f; do
            cp "$f" ../out_apk/ || true
            echo "Copied APK: $f"
          done < <(find app/build/outputs -type f -name "*.apk" -print0 || true)

          echo "=== Out AAB listing ==="
          ls -la ../out_aab || true
          echo "=== Out APK listing ==="
          ls -la ../out_apk || true

          if [ "$AAB_FOUND" -ne 1 ]; then
            echo "ERROR: No .aab artifact found in app/build/outputs."
            exit 1 # Fail the build if AAB is not found
          fi

      - name: Upload Signed AAB (For Play Console)
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: out_aab

      - name: Upload Signed APK (For Testing)
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk
          path: out_apk
