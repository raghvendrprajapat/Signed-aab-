name: Build Offline Android App

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Offline App"
      APP_ID:
        description: "Package ID"
        required: true
        default: "com.example.app"
      WEB_URL:
        description: "Website URL"
        required: true
        default: "https://example.com"
      VERSION_NAME:
        description: "Version"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Version code"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target SDK"
        required: true
        default: "35"
      DOWNLOAD_DEPTH:
        description: "Crawl depth"
        required: true
        default: "2"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      WEB_URL: ${{ github.event.inputs.WEB_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      MIN_SDK: "22"
      DOWNLOAD_DEPTH: ${{ github.event.inputs.DOWNLOAD_DEPTH }}
      KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download website
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          mkdir -p website
          cd website
          wget --recursive --level=${{ github.event.inputs.DOWNLOAD_DEPTH }} --no-parent --convert-links --page-requisites --no-host-directories --restrict-file-names=windows --timeout=30 --tries=3 "${{ github.event.inputs.WEB_URL }}" || true
          if [ ! -f index.html ]; then
            echo '<html><body><h1>Offline App</h1></body></html>' > index.html
          fi
          cd ..
          echo "WEB_DIR=website" >> $GITHUB_ENV

      - name: Install Capacitor
        run: |
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Validate secrets
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then echo "Missing ANDROID_KEYSTORE_BASE64"; exit 1; fi
          if [ -z "$KEYSTORE_PASSWORD" ]; then echo "Missing KEYSTORE_PASSWORD"; exit 1; fi
          if [ -z "$KEY_ALIAS" ]; then echo "Missing KEY_ALIAS"; exit 1; fi
          if [ -z "$KEY_PASSWORD" ]; then echo "Missing KEY_PASSWORD"; exit 1; fi

      - name: Restore keystore
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
          ls -lh android.keystore

      - name: Configure Capacitor
        run: |
          npx cap init "$APP_NAME" "$APP_ID" --web-dir=website
          cat > capacitor.config.json << 'ENDCONFIG'
          {
            "appId": "REPLACE_APP_ID",
            "appName": "REPLACE_APP_NAME",
            "webDir": "website",
            "bundledWebRuntime": true,
            "android": {
              "allowMixedContent": false
            }
          }
          ENDCONFIG
          sed -i "s/REPLACE_APP_ID/$APP_ID/g" capacitor.config.json
          sed -i "s/REPLACE_APP_NAME/$APP_NAME/g" capacitor.config.json
          npx cap add android
          npx cap sync android

      - name: Configure Gradle
        working-directory: android
        run: |
          cp ../android.keystore app/release.keystore
          BUILD_FILE="app/build.gradle"
          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" "$BUILD_FILE"
          sed -i "s/versionName .*/versionName \"$VERSION_NAME\"/" "$BUILD_FILE"
          sed -i "s/minSdk .*/minSdk $MIN_SDK/" "$BUILD_FILE"
          sed -i "s/targetSdk .*/targetSdk $TARGET_SDK/" "$BUILD_FILE"
          sed -i "s/compileSdk .*/compileSdk $TARGET_SDK/" "$BUILD_FILE"
          echo "" >> "$BUILD_FILE"
          echo "android {" >> "$BUILD_FILE"
          echo "    signingConfigs {" >> "$BUILD_FILE"
          echo "        release {" >> "$BUILD_FILE"
          echo "            storeFile file('release.keystore')" >> "$BUILD_FILE"
          echo "            storePassword System.getenv('KEYSTORE_PASSWORD')" >> "$BUILD_FILE"
          echo "            keyAlias System.getenv('KEY_ALIAS')" >> "$BUILD_FILE"
          echo "            keyPassword System.getenv('KEY_PASSWORD')" >> "$BUILD_FILE"
          echo "        }" >> "$BUILD_FILE"
          echo "    }" >> "$BUILD_FILE"
          echo "    buildTypes {" >> "$BUILD_FILE"
          echo "        release {" >> "$BUILD_FILE"
          echo "            signingConfig signingConfigs.release" >> "$BUILD_FILE"
          echo "        }" >> "$BUILD_FILE"
          echo "    }" >> "$BUILD_FILE"
          echo "}" >> "$BUILD_FILE"

      - name: Build APK and AAB
        working-directory: android
        run: |
          ./gradlew clean --no-daemon
          ./gradlew assembleRelease bundleRelease --no-daemon
          mkdir -p ../output
          cp app/build/outputs/apk/release/*.apk ../output/ || true
          cp app/build/outputs/bundle/release/*.aab ../output/ || true
          ls -lh ../output/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: output
          retention-days: 30
