name: Build Web to Signed Android

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Web2App"
      APP_ID:
        description: "Package ID (e.g. com.example.app)"
        required: true
        default: "com.example.web2app"
      WEB_URL:
        description: "Live URL (https:// required unless ALLOW_MIXED_CONTENT=true)"
        required: true
        default: "https://example.com"
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer for versionCode"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target/compile SDK"
        required: true
        default: "35"
      ALLOW_MIXED_CONTENT:
        description: "Allow http content? true/false"
        required: true
        default: "false"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 50

    env:
      MIN_SDK: "22"
      # secrets expected:
      KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare web build directory
        shell: bash
        run: |
          set -euo pipefail
          # Determine WEB_BUILD_DIR
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
            if npm run | grep -q " build"; then npm run build || true; fi
            for d in dist build public; do
              if [ -d "$d" ]; then
                echo "WEB_BUILD_DIR=$d" >> $GITHUB_ENV
                break
              fi
            done
          fi
          if ! grep -q '^WEB_BUILD_DIR=' $GITHUB_ENV 2>/dev/null; then
            mkdir -p minimal_www
            echo '<!doctype html><html><body>Loadingâ€¦</body></html>' > minimal_www/index.html
            echo "WEB_BUILD_DIR=minimal_www" >> $GITHUB_ENV
          fi
          npm install -D @capacitor/core @capacitor/cli @capacitor/android

      - name: Validate inputs & secrets
        shell: bash
        run: |
          set -euo pipefail
          APP_ID="${{ github.event.inputs.APP_ID }}"
          VERSION_CODE="${{ github.event.inputs.VERSION_CODE }}"
          WEB_URL="${{ github.event.inputs.WEB_URL }}"
          ALLOW_MIXED_CONTENT="${{ github.event.inputs.ALLOW_MIXED_CONTENT }}"
          if [[ ! "$APP_ID" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "Invalid APP_ID: $APP_ID"
            exit 1
          fi
          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            echo "VERSION_CODE must be integer"
            exit 1
          fi
          if [[ "$ALLOW_MIXED_CONTENT" != "true" && ! "$WEB_URL" =~ ^https:// ]]; then
            echo "WEB_URL must start with https:// (or set ALLOW_MIXED_CONTENT=true)"
            exit 1
          fi
          for s in KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD; do
            if [ -z "${!s:-}" ]; then
              echo "Missing secret: $s"
              exit 1
            fi
          done

      - name: Restore keystore
        shell: bash
        run: |
          set -euo pipefail
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
          ls -l android.keystore

      - name: Ensure android project folder
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p android/app/src/main/assets

      - name: Copy web build into Android assets (bundle for offline)
        shell: bash
        run: |
          set -euo pipefail
          WEB_BUILD_DIR="${WEB_BUILD_DIR:-}"
          if [ -z "$WEB_BUILD_DIR" ]; then
            echo "WEB_BUILD_DIR is not set"; exit 1
          fi
          rm -rf android/app/src/main/assets/public || true
          mkdir -p android/app/src/main/assets/public
          cp -a "$WEB_BUILD_DIR/." android/app/src/main/assets/public/ || true
          mkdir -p android/app/src/main/assets/www
          cp -a "$WEB_BUILD_DIR/." android/app/src/main/assets/www/ || true
          echo "Copied web files into assets (sample):"
          ls -1 android/app/src/main/assets/public | sed -n '1,20p' || true

      - name: Init Capacitor & set minimal config
        shell: bash
        run: |
          set -euo pipefail
          APP_NAME="${{ github.event.inputs.APP_NAME }}"
          APP_ID="${{ github.event.inputs.APP_ID }}"
          npx cap init "$APP_NAME" "$APP_ID" --web-dir="$WEB_BUILD_DIR" || true
          # create minimal config that ensures bundled web runtime
          jq -n --arg id "$APP_ID" --arg name "$APP_NAME" --arg web "$WEB_BUILD_DIR" --argjson bundled true \
            '{appId:$id, appName:$name, webDir:$web, bundledWebRuntime:$bundled}' > capacitor.config.json

      - name: Add Android platform & copy assets
        shell: bash
        run: |
          set -euo pipefail
          npx cap add android || true
          npx cap copy android || true
          npx cap sync android || true

      - name: Copy keystore to android app
        shell: bash
        run: |
          set -euo pipefail
          cp android.keystore android/app/release.keystore || true
          chmod 600 android/app/release.keystore || true

      - name: Patch app gradle for signing and versions (safe append)
        shell: bash
        run: |
          set -euo pipefail
          VERSION_NAME="${{ github.event.inputs.VERSION_NAME }}"
          VERSION_CODE="${{ github.event.inputs.VERSION_CODE }}"
          TARGET_SDK="${{ github.event.inputs.TARGET_SDK }}"
          MIN_SDK="${{ env.MIN_SDK }}"
          FILE=""
          if [ -f android/app/build.gradle ]; then
            FILE="android/app/build.gradle"
          elif [ -f android/app/build.gradle.kts ]; then
            FILE="android/app/build.gradle.kts"
          else
            # no file found, skip
            echo "No app build.gradle found; skipping gradle patch"
            exit 0
          fi
          # Safe replacements (if present)
          sed -i -E "s/versionCode[[:space:]]+[0-9]+/versionCode $VERSION_CODE/g" "$FILE" || true
          sed -i -E "s/versionName[[:space:]]+\"[^\"]+\"/versionName \"$VERSION_NAME\"/g" "$FILE" || true
          sed -i -E "s/compileSdkVersion[[:space:]]+[0-9]+/compileSdkVersion $TARGET_SDK/g" "$FILE" || true
          sed -i -E "s/targetSdkVersion[[:space:]]+[0-9]+/targetSdkVersion $TARGET_SDK/g" "$FILE" || true
          sed -i -E "s/minSdkVersion[[:space:]]+[0-9]+/minSdkVersion $MIN_SDK/g" "$FILE" || true
          # Append signing config if not exists
          if ! grep -q "signingConfigs" "$FILE" 2>/dev/null; then
            cat >> "$FILE" <<'EOF'

android {
    signingConfigs {
        release {
            storeFile file("release.keystore")
            storePassword System.getenv("KEYSTORE_PASSWORD")
            keyAlias System.getenv("KEY_ALIAS")
            keyPassword System.getenv("KEY_PASSWORD")
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
            minifyEnabled false
            shrinkResources false
            debuggable false
        }
    }
}
EOF
          fi

      - name: Build release AAB and APK
        shell: bash
        run: |
          set -euo pipefail
          cd android
          ./gradlew clean --no-daemon
          ./gradlew :app:bundleRelease :app:assembleRelease --no-daemon

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out_aab out_apk
          cp android/app/build/outputs/bundle/release/*.aab out_aab/ 2>/dev/null || true
          cp android/app/build/outputs/apk/release/*.apk out_apk/ 2>/dev/null || true
          echo "AAB count:"
          ls -l out_aab || true
          echo "APK count:"
          ls -l out_apk || true

      - name: Upload signed-aab
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: out_aab

      - name: Upload signed-apk
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk
          path: out_apk
