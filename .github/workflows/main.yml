name: Build OFFLINE Web to Signed Android (Fully Bundled)

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: "App name"
        required: true
        default: "My Offline App"
      APP_ID:
        description: "Package ID (e.g. com.raghvendr.app)"
        required: true
        default: "com.example.offlineapp"
      WEB_URL:
        description: "Website URL to download and bundle (https:// preferred)"
        required: true
        default: "https://example.com"
      VERSION_NAME:
        description: "Public version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"
      VERSION_CODE:
        description: "Integer version code (increase for each upload)"
        required: true
        default: "1"
      TARGET_SDK:
        description: "Target SDK version"
        required: true
        default: "35"
      DOWNLOAD_DEPTH:
        description: "Website crawl depth (1-3 recommended)"
        required: true
        default: "2"
      PLUGINS:
        description: "Native plugins to include"
        required: true
        type: choice
        default: "none"
        options:
          - "none"
          - "camera"
          - "push"
          - "location"
          - "all"
      APP_ICON_URL:
        description: "Icon URL (optional - PNG 512x512+)"
        required: false
        default: ""
      SPLASH_SCREEN_URL:
        description: "Splash screen URL (optional - PNG)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      APP_NAME: ${{ github.event.inputs.APP_NAME }}
      APP_ID: ${{ github.event.inputs.APP_ID }}
      WEB_URL: ${{ github.event.inputs.WEB_URL }}
      VERSION_NAME: ${{ github.event.inputs.VERSION_NAME }}
      VERSION_CODE: ${{ github.event.inputs.VERSION_CODE }}
      TARGET_SDK: ${{ github.event.inputs.TARGET_SDK }}
      MIN_SDK: "22"
      DOWNLOAD_DEPTH: ${{ github.event.inputs.DOWNLOAD_DEPTH }}
      PLUGINS: ${{ github.event.inputs.PLUGINS }}

      KEYSTORE_BASE64:   ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CRITICAL: Download entire website for offline bundling
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Download website content for offline bundling
        shell: bash
        run: |
          set -euo pipefail
          
          echo "ğŸŒ Downloading website: $WEB_URL"
          echo "ğŸ“Š Crawl depth: $DOWNLOAD_DEPTH levels"
          
          # Install wget for recursive website download
          sudo apt-get update -y
          sudo apt-get install -y wget
          
          # Create clean download directory
          mkdir -p offline_website
          cd offline_website
          
          # Download website recursively with optimizations
          wget \
            --recursive \
            --level="$DOWNLOAD_DEPTH" \
            --no-parent \
            --convert-links \
            --adjust-extension \
            --page-requisites \
            --no-host-directories \
            --restrict-file-names=windows \
            --reject "*.exe,*.dmg,*.zip,*.tar.gz,*.pdf" \
            --limit-rate=5m \
            --wait=0.5 \
            --random-wait \
            --user-agent="Mozilla/5.0 (Android 13; Mobile) AppleWebKit/537.36" \
            --timeout=30 \
            --tries=3 \
            "$WEB_URL" || echo "âš ï¸ Some files may have failed - continuing..."
          
          # Ensure index.html exists
          if [ ! -f index.html ] && [ -f *.html ]; then
            mv $(ls *.html | head -n1) index.html
          fi
          
          if [ ! -f index.html ]; then
            echo "âš ï¸ No HTML downloaded - creating fallback"
            cat > index.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container { max-width: 500px; }
        h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        p { font-size: 1.2rem; opacity: 0.9; line-height: 1.6; }
        .status { 
            background: rgba(255,255,255,0.2); 
            padding: 15px 30px; 
            border-radius: 50px; 
            margin-top: 30px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± App Ready</h1>
        <p>This app works completely offline. All content is bundled within the application.</p>
        <div class="status">âœ… Offline Mode Active</div>
    </div>
</body>
</html>
HTMLEOF
          fi
          
          cd ..
          
          # Statistics
          FILE_COUNT=$(find offline_website -type f | wc -l)
          TOTAL_SIZE=$(du -sh offline_website | cut -f1)
          
          echo "âœ… Download complete!"
          echo "ğŸ“ Files downloaded: $FILE_COUNT"
          echo "ğŸ’¾ Total size: $TOTAL_SIZE"
          echo "ğŸ“‚ Directory structure:"
          ls -lah offline_website | head -n 20
          
          # Set as web build directory
          echo "WEB_BUILD_DIR=offline_website" >> $GITHUB_ENV

      - name: Install Capacitor and dependencies
        shell: bash
        run: |
          set -euo pipefail
          npm install -D @capacitor/core @capacitor/cli @capacitor/android
          
          # Install optional plugins based on selection
          case "$PLUGINS" in
            camera)
              npm install @capacitor/camera
              ;;
            push)
              npm install @capacitor/push-notifications
              ;;
            location)
              npm install @capacitor/geolocation
              ;;
            all)
              npm install @capacitor/camera @capacitor/push-notifications @capacitor/geolocation
              ;;
          esac

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          
          # Validate package ID format
          if [[ ! "$APP_ID" =~ ^[a-z]+([a-z0-9_]*)(\.[a-z][a-z0-9_]*)+$ ]]; then
            echo "âŒ Invalid APP_ID: $APP_ID"
            echo "Must be like: com.company.appname"
            exit 1
          fi
          
          # Validate version code
          if ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            echo "âŒ VERSION_CODE must be a positive integer"
            exit 1
          fi
          
          # Validate keystore secrets
          for var in KEYSTORE_BASE64 KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD; do
            if [ -z "${!var:-}" ]; then
              echo "âŒ Missing required secret: $var"
              echo "Configure this in: Repository Settings â†’ Secrets â†’ Actions"
              exit 1
            fi
          done
          
          echo "âœ… All inputs validated successfully"

      - name: Restore signing keystore
        shell: bash
        run: |
          set -euo pipefail
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
          
          if [ ! -f android.keystore ]; then
            echo "âŒ Keystore restoration failed"
            exit 1
          fi
          
          echo "âœ… Keystore restored: $(ls -lh android.keystore)"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CRITICAL: Configure for OFFLINE operation (bundled mode)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Configure Capacitor for OFFLINE bundled mode
        shell: bash
        run: |
          set -euo pipefail
          
          echo "ğŸ”§ Configuring Capacitor for OFFLINE operation..."
          
          # Initialize Capacitor
          npx cap init "$APP_NAME" "$APP_ID" --web-dir="$WEB_BUILD_DIR" || true
          
          # Create OFFLINE-optimized capacitor.config.json
          cat > capacitor.config.json << CONFEOF
{
  "appId": "$APP_ID",
  "appName": "$APP_NAME",
  "webDir": "$WEB_BUILD_DIR",
  "bundledWebRuntime": true,
  "android": {
    "allowMixedContent": false,
    "captureInput": true,
    "webContentsDebuggingEnabled": false,
    "minWebViewVersion": 55,
    "backgroundColor": "#ffffff"
  },
  "plugins": {
    "SplashScreen": {
      "launchShowDuration": 2000,
      "backgroundColor": "#ffffff",
      "showSpinner": false
    }
  }
}
CONFEOF
          
          echo "âœ… Capacitor configured for OFFLINE mode"
          echo "ğŸ“„ Configuration:"
          cat capacitor.config.json
          
          # Add Android platform and sync
          npx cap add android || true
          npx cap sync android
          
          echo "âœ… Android platform added and synced"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Apply branding (icons + splash) - UNCHANGED (works well)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Apply branding assets from URLs
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail

          ICON_SRC="${{ github.event.inputs.APP_ICON_URL }}"
          SPLASH_SRC="${{ github.event.inputs.SPLASH_SCREEN_URL }}"

          if [ -z "$ICON_SRC" ] && [ -z "$SPLASH_SRC" ]; then
            echo "â„¹ï¸ No branding URLs provided - using defaults"
            exit 0
          fi

          # Helper function for safe downloads
          dl() {
            url="$1"
            out="$2"
            echo "â¬‡ï¸ Downloading: $url â†’ $out"
            curl -sfSL --max-time 30 "$url" -o "$out" || {
              echo "âš ï¸ Download failed (ignored): $url"
            }
          }

          # Install ImageMagick for processing
          sudo apt-get update -y
          sudo apt-get install -y imagemagick

          # Download and process ICON
          if [ -n "$ICON_SRC" ]; then
            echo "ğŸ¨ Processing app icon..."
            
            if [[ "$ICON_SRC" =~ \.png$ ]]; then
              dl "$ICON_SRC" /tmp/icon_src.png
            else
              [[ "$ICON_SRC" != */ ]] && ICON_SRC="$ICON_SRC/"
              dl "${ICON_SRC}icon_xxxhdpi.png" /tmp/icon_src.png
              [ ! -f /tmp/icon_src.png ] && dl "${ICON_SRC}icon.png" /tmp/icon_src.png
            fi
          fi

          # Download and process SPLASH
          if [ -n "$SPLASH_SRC" ]; then
            echo "ğŸ–¼ï¸ Processing splash screen..."
            
            if [[ "$SPLASH_SRC" =~ \.png$ ]]; then
              dl "$SPLASH_SRC" /tmp/splash.png
            else
              [[ "$SPLASH_SRC" != */ ]] && SPLASH_SRC="$SPLASH_SRC/"
              dl "${SPLASH_SRC}splash.png" /tmp/splash.png
            fi
          fi

          # Clean previous resources
          echo "ğŸ§¹ Cleaning old resources..."
          rm -rf app/src/main/res/mipmap-* app/src/main/res/drawable*

          # Create resource directories
          mkdir -p app/src/main/res/{mipmap-{xxxhdpi,xxhdpi,xhdpi,hdpi,mdpi,anydpi-v26},drawable,drawable-nodpi}

          # Process and install ICON
          if [ -f /tmp/icon_src.png ]; then
            # Flatten transparency
            convert /tmp/icon_src.png -background white -alpha remove -alpha off /tmp/icon_flat.png

            # Generate all densities
            convert /tmp/icon_flat.png -resize 192x192\! /tmp/icon_xxxhdpi.png
            convert /tmp/icon_flat.png -resize 144x144\! /tmp/icon_xxhdpi.png
            convert /tmp/icon_flat.png -resize 96x96\!   /tmp/icon_xhdpi.png
            convert /tmp/icon_flat.png -resize 72x72\!   /tmp/icon_hdpi.png
            convert /tmp/icon_flat.png -resize 48x48\!   /tmp/icon_mdpi.png

            # Install launcher icons (legacy)
            for density in xxxhdpi xxhdpi xhdpi hdpi mdpi; do
              cp /tmp/icon_${density}.png app/src/main/res/mipmap-${density}/ic_launcher.png
              cp /tmp/icon_${density}.png app/src/main/res/mipmap-${density}/ic_launcher_round.png
            done

            # Adaptive icon (Android 8+)
            cp /tmp/icon_flat.png app/src/main/res/mipmap-anydpi-v26/ic_launcher_foreground.png
            convert -size 108x108 xc:white app/src/main/res/mipmap-anydpi-v26/ic_launcher_background.png

            cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml << 'ICONXML'
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@mipmap/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>
ICONXML

            cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml << 'ICONXML'
<?xml version="1.0" encoding="utf-8"?>
<adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
    <background android:drawable="@mipmap/ic_launcher_background"/>
    <foreground android:drawable="@mipmap/ic_launcher_foreground"/>
</adaptive-icon>
ICONXML

            echo "âœ… Icon installed"
          fi

          # Process and install SPLASH
          if [ -f /tmp/splash.png ]; then
            convert /tmp/splash.png -background white -alpha remove -alpha off /tmp/splash_flat.png
            cp /tmp/splash_flat.png app/src/main/res/drawable-nodpi/splash.png
            cp /tmp/splash_flat.png app/src/main/res/drawable/splash.png

            cat > app/src/main/res/drawable/launch_splash.xml << 'SPLASHXML'
<?xml version="1.0" encoding="utf-8"?>
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="@android:color/white"/>
    <item>
        <bitmap
            android:gravity="center"
            android:src="@drawable/splash"/>
    </item>
</layer-list>
SPLASHXML

            echo "âœ… Splash screen installed"
          fi

          echo "âœ… Branding complete"

      - name: Update Android manifest
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          
          MF="app/src/main/AndroidManifest.xml"
          
          if [ ! -f "$MF" ]; then
            echo "âš ï¸ AndroidManifest.xml not found"
            exit 0
          fi
          
          # Update icon references
          perl -0777 -pe '
            if (/<application\b[^>]*>/s) {
              $app = $&;
              $new = $app;
              
              # Set icon
              if ($new !~ /android:icon=/) {
                $new =~ s/<application/<application android:icon=\"\@mipmap\/ic_launcher\"/;
              } else {
                $new =~ s/android:icon=\"[^\"]*\"/android:icon=\"\@mipmap\/ic_launcher\"/g;
              }
              
              # Set round icon
              if ($new !~ /android:roundIcon=/) {
                $new =~ s/<application/<application android:roundIcon=\"\@mipmap\/ic_launcher_round\"/;
              } else {
                $new =~ s/android:roundIcon=\"[^\"]*\"/android:roundIcon=\"\@mipmap\/ic_launcher_round\"/g;
              }
              
              s/\Q$app\E/$new/;
            }
          ' -i "$MF"
          
          echo "âœ… Manifest updated"

      - name: Configure Gradle for signing
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          
          # Copy keystore
          cp ../android.keystore app/release.keystore
          
          # Detect Gradle file
          if [ -f app/build.gradle ]; then
            FILE="app/build.gradle"
          else
            FILE="app/build.gradle.kts"
          fi
          
          echo "ğŸ“ Configuring: $FILE"
          
          # Update version codes and SDK versions
          sed -i -E "s/versionCode[ =]+[0-9]+/versionCode $VERSION_CODE/" "$FILE"
          sed -i -E "s/versionName[ =]+\"[^\"]+\"/versionName \"$VERSION_NAME\"/" "$FILE"
          sed -i -E "s/minSdkVersion[ =]+[0-9]+/minSdkVersion $MIN_SDK/" "$FILE"
          sed -i -E "s/minSdk[ =]+[0-9]+/minSdk $MIN_SDK/" "$FILE"
          sed -i -E "s/targetSdkVersion[ =]+[0-9]+/targetSdkVersion $TARGET_SDK/" "$FILE"
          sed -i -E "s/targetSdk[ =]+[0-9]+/targetSdk $TARGET_SDK/" "$FILE"
          sed -i -E "s/compileSdkVersion[ =]+[0-9]+/compileSdkVersion $TARGET_SDK/" "$FILE"
          sed -i -E "s/compileSdk[ =]+[0-9]+/compileSdk $TARGET_SDK/" "$FILE"
          
          # Add signing configuration if missing
          if ! grep -q "signingConfigs" "$FILE"; then
            cat >> "$FILE" << 'GRADLEOF'

android {
    signingConfigs {
        release {
            storeFile file("release.keystore")
            storePassword System.getenv("KEYSTORE_PASSWORD")
            keyAlias System.getenv("KEY_ALIAS")
            keyPassword System.getenv("KEY_PASSWORD")
        }
    }
    
    buildTypes {
        release {
            signingConfig signingConfigs.release
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}
GRADLEOF
          fi
          
          echo "âœ… Gradle configured"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Build optimized release builds
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Build signed APK and AAB
        shell: bash
        working-directory: android
        run: |
          set -euo pipefail
          
          echo "ğŸ—ï¸ Building release artifacts..."
          
          # Clean previous builds
          ./gradlew clean --no-daemon
          
          # Build both APK and AAB
          ./gradlew \
            :app:assembleRelease \
            :app:bundleRelease \
            --no-daemon \
            --warning-mode all
          
          # Organize outputs
          mkdir -p ../release_output/{apk,aab}
          
          # Copy APK
          if ls app/build/outputs/apk/release/*.apk 1>/dev/null 2>&1; then
            cp app/build/outputs/apk/release/*.apk ../release_output/apk/
            echo "âœ… APK built: $(ls -lh ../release_output/apk/*.apk)"
          fi
          
          # Copy AAB
          if ls app/build/outputs/bundle/release/*.aab 1>/dev/null 2>&1; then
            cp app/build/outputs/bundle/release/*.aab ../release_output/aab/
            echo "âœ… AAB built: $(ls -lh ../release_output/aab/*.aab)"
          fi
          
          # Verify signing
          if command -v apksigner &>/dev/null; then
            for apk in ../release_output/apk/*.apk; do
              echo "ğŸ” Verifying signature: $(basename $apk)"
              apksigner verify --verbose "$apk" || echo "âš ï¸ Signature verification unavailable"
            done
          fi
          
          echo "âœ… Build complete!"

      - name: Generate build report
        shell: bash
        run: |
          set -euo pipefail
          
          cat > build-report.txt << REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        OFFLINE ANDROID BUILD REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“± App Information:
   Name:        $APP_NAME
   Package ID:  $APP_ID
   Version:     $VERSION_NAME ($VERSION_CODE)
   Target SDK:  $TARGET_SDK

ğŸŒ Content Source:
   Website:     $WEB_URL
   Crawl Depth: $DOWNLOAD_DEPTH levels
   Mode:        FULLY OFFLINE (bundled)

ğŸ“¦ Build Outputs:
   APK Size:    $(du -h release_output/apk/*.apk 2>/dev/null | cut -f1 || echo "N/A")
   AAB Size:    $(du -h release_output/aab/*.aab 2>/dev/null | cut -f1 || echo "N/A")

ğŸ”Œ Plugins Included:
   $PLUGINS

âœ… Build Status:   SUCCESS
ğŸ“… Build Date:     $(date -u +"%Y-%m-%d %H:%M:%S UTC")

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
IMPORTANT: This app works 100% OFFLINE after installation.
All website content is bundled inside the APK/AAB.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
REPORT
          
          cat build-report.txt
          cp build-report.txt release_output/

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk-offline
          path: release_output/apk
          retention-days: 30

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab-offline
          path: release_output/aab
          retention-days: 30

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: release_output/build-report.txt
          retention-days: 30
